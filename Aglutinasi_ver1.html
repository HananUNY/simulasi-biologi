<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Laboratorium Imunohematologi Lengkap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mencegah scroll pada body saat touch di canvas */
        canvas { touch-action: none; }
        
        /* Custom Checkbox Style */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4ade80;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4ade80;
        }

        /* Scrollbar styling untuk panel kontrol agar terlihat rapi di mobile */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans h-screen flex flex-col overflow-hidden fixed inset-0">

    <!-- Header: Compact di Mobile -->
    <div class="px-3 py-2 md:p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center z-10 shadow-md shrink-0 h-14 md:h-auto">
        <div class="overflow-hidden">
            <h1 class="text-sm md:text-2xl font-bold text-blue-400 truncate">Lab Darah Virtual</h1>
            <p class="text-[10px] md:text-sm text-slate-400 hidden md:block">Simulasi Sel Darah Merah, Plasma, dan Serum Reagen</p>
        </div>
        <button onclick="resetSimulation()" class="bg-red-600 hover:bg-red-500 text-white px-2 py-1 md:px-4 md:py-2 rounded text-xs md:text-sm font-bold shadow transition border border-red-400 whitespace-nowrap">
            RESET
        </button>
    </div>

    <!-- Main Content -->
    <div class="flex-1 relative flex flex-col md:flex-row overflow-hidden">
        
        <!-- Canvas Container -->
        <!-- MOBILE: Order-1 (Di Atas), Desktop: Order-1 (Di Kiri - Flex Row) -->
        <!-- Menggunakan flex-1 agar mengisi sisa ruang yang tidak dipakai kontrol panel -->
        <div class="relative flex-1 bg-white overflow-hidden cursor-crosshair group order-1 w-full">
            <!-- Background Visual -->
            <div class="absolute inset-0 flex items-center justify-center opacity-5 pointer-events-none">
                 <div class="w-[60vmin] h-[60vmin] md:w-[80vmin] md:h-[80vmin] rounded-full border-4 md:border-8 border-slate-900 bg-slate-100"></div>
            </div>
            
            <canvas id="simCanvas" class="block w-full h-full touch-none"></canvas>

            <!-- Warning Overlay: Responsive Size -->
            <div id="statusLabel" class="absolute top-4 md:top-6 left-1/2 transform -translate-x-1/2 bg-red-600/90 backdrop-blur-sm text-white px-4 py-2 md:px-6 md:py-3 rounded-lg shadow-2xl opacity-0 transition-opacity duration-300 pointer-events-none flex items-center gap-2 md:gap-3 border border-red-400 z-20 w-max max-w-[90%]">
                <span class="relative flex h-2 w-2 md:h-3 md:w-3 shrink-0">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 md:h-3 md:w-3 bg-yellow-500"></span>
                </span>
                <div class="text-center md:text-left">
                    <div class="text-yellow-300 uppercase tracking-wider text-[8px] md:text-[10px]">Reaksi Terdeteksi</div>
                    <div class="text-xs md:text-lg font-bold">AGLUTINASI</div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <!-- MOBILE: Order-2 (Di Bawah), Desktop: Order-2 (Di Kanan) -->
        <!-- Tinggi di mobile dibatasi (h-[45%]) agar canvas tetap terlihat dominan -->
        <div class="w-full md:w-80 h-[45%] md:h-full bg-slate-800 border-t md:border-t-0 md:border-l border-slate-700 flex flex-col shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.3)] z-20 order-2 overflow-hidden">
            
            <!-- Scrollable Content Area -->
            <div class="flex-1 overflow-y-auto p-3 md:p-4 space-y-4 md:space-y-6">
                
                <!-- Section 1: Blood Donors -->
                <div class="space-y-2 md:space-y-3">
                    <div class="flex justify-between items-center border-b border-slate-600 pb-1 md:pb-2">
                        <h3 class="text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-wider">1. Sampel Darah</h3>
                    </div>

                    <!-- TOGGLE SWITCH: Compact -->
                    <div class="flex items-center justify-between bg-slate-700/50 p-2 rounded-lg border border-slate-600">
                        <span class="text-[10px] md:text-xs font-semibold text-slate-300 leading-tight">Sertakan Plasma? <br><span class="text-[9px] md:text-[10px] text-slate-500 font-normal">(Antibodi Alami)</span></span>
                        <label for="plasmaToggle" class="flex items-center cursor-pointer relative shrink-0">
                            <input type="checkbox" id="plasmaToggle" class="sr-only peer" checked onchange="updateToggleLabel()">
                            <div class="w-9 h-5 md:w-11 md:h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 md:after:h-5 md:after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                        </label>
                    </div>

                    <!-- Buttons Grid -->
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="addBloodSample('A')" class="bg-slate-700 hover:bg-slate-600 p-1.5 md:p-2 rounded flex flex-col items-center gap-1 border border-slate-600 hover:border-red-400 transition group active:scale-95">
                            <div class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-red-600 text-white text-xs md:text-sm font-bold flex items-center justify-center shadow-inner border border-white/20">A</div>
                            <span class="text-[9px] md:text-xs font-bold">A</span>
                        </button>
                        <button onclick="addBloodSample('B')" class="bg-slate-700 hover:bg-slate-600 p-1.5 md:p-2 rounded flex flex-col items-center gap-1 border border-slate-600 hover:border-blue-400 transition group active:scale-95">
                            <div class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-red-600 text-white text-xs md:text-sm font-bold flex items-center justify-center shadow-inner border border-white/20">B</div>
                            <span class="text-[9px] md:text-xs font-bold">B</span>
                        </button>
                        <button onclick="addBloodSample('AB')" class="bg-slate-700 hover:bg-slate-600 p-1.5 md:p-2 rounded flex flex-col items-center gap-1 border border-slate-600 hover:border-purple-400 transition group active:scale-95">
                            <div class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-purple-700 text-white text-xs md:text-sm font-bold flex items-center justify-center shadow-inner border border-white/20">AB</div>
                            <span class="text-[9px] md:text-xs font-bold">AB</span>
                        </button>
                        <button onclick="addBloodSample('O')" class="bg-slate-700 hover:bg-slate-600 p-1.5 md:p-2 rounded flex flex-col items-center gap-1 border border-slate-600 hover:border-green-400 transition group active:scale-95">
                            <div class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-red-600 text-white text-xs md:text-sm font-bold flex items-center justify-center shadow-inner border border-white/20">O</div>
                            <span class="text-[9px] md:text-xs font-bold">O</span>
                        </button>
                    </div>
                </div>

                <!-- Section 2: Reagents -->
                <div class="space-y-2 md:space-y-3">
                    <h3 class="text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-slate-600 pb-1 md:pb-2">2. Reagen (Serum)</h3>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="addReagent('Anti-A')" class="bg-yellow-500/10 hover:bg-yellow-500/20 border border-yellow-500/50 text-yellow-400 p-2 md:p-3 rounded-lg flex flex-col items-center justify-center transition active:bg-yellow-500/30">
                            <span class="font-bold text-xs md:text-sm">Anti-A</span>
                            <span class="text-[9px] md:text-xs opacity-70">Kuning</span>
                        </button>

                        <button onclick="addReagent('Anti-B')" class="bg-blue-500/10 hover:bg-blue-500/20 border border-blue-500/50 text-blue-400 p-2 md:p-3 rounded-lg flex flex-col items-center justify-center transition active:bg-blue-500/30">
                            <span class="font-bold text-xs md:text-sm">Anti-B</span>
                            <span class="text-[9px] md:text-xs opacity-70">Biru</span>
                        </button>
                    </div>
                </div>

                <!-- Log Box: Disembunyikan sebagian di mobile agar tidak makan tempat -->
                <div class="flex-1 min-h-[60px] md:min-h-[100px] bg-black/40 p-2 rounded border border-slate-700 text-[10px] md:text-xs text-slate-300 overflow-y-auto font-mono flex flex-col-reverse" id="logBox">
                    <div class="text-slate-500 italic">Siap...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const statusLabel = document.getElementById('statusLabel');
        const logBox = document.getElementById('logBox');
        const plasmaToggle = document.getElementById('plasmaToggle');

        let width, height;
        let cells = [];
        let antibodies = [];
        
        // Configuration
        const CELL_RADIUS = 15;
        const ANTIBODY_SIZE = 12;
        const SPRING_STRENGTH = 0.08; 
        const REPULSION_STRENGTH = 0.6; 

        function resize() {
            // Mengambil ukuran dari parent container agar responsif terhadap flexbox
            const container = canvas.parentElement;
            width = container.clientWidth;
            height = container.clientHeight;
            
            // Set canvas size secara eksplisit agar tidak blur di retina display
            const dpr = window.devicePixelRatio || 1;
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            
            // Normalize coordinate system
            ctx.scale(dpr, dpr);
            
            // Adjust width/height logic variables to match css pixels
            // (Variabel global width/height tetap menggunakan CSS pixels untuk logika fisika)
        }

        window.addEventListener('resize', () => {
            resize();
            // Reset boundaries check slightly to push particles inside if screen shrank
            cells.forEach(c => {
                 if(c.x > width) c.x = width - 10;
                 if(c.y > height) c.y = height - 10;
            });
        });
        
        // Panggil resize di awal
        setTimeout(resize, 100); // Delay sedikit untuk memastikan layout flexbox sudah render

        // --- LOG BOX UTILS ---
        function log(msg, type="neutral") {
            const div = document.createElement('div');
            div.textContent = `> ${msg}`;
            div.className = "mb-1 border-b border-slate-800 pb-1 shrink-0 leading-tight";
            if(type === "danger") div.className += " text-red-400 font-bold";
            if(type === "success") div.className += " text-green-400";
            if(type === "info") div.className += " text-blue-300";
            if(type === "warning") div.className += " text-yellow-300";
            
            if (logBox.children.length > 20) {
                logBox.removeChild(logBox.lastChild);
            }
            logBox.prepend(div);
        }

        function updateToggleLabel() {
            if(plasmaToggle.checked) {
                log("Mode: Darah Utuh (Sel + Plasma)", "info");
            } else {
                log("Mode: Packed Cells (Sel Saja)", "info");
            }
        }

        // --- CLASSES ---

        class RedBloodCell {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                // KECEPATAN AWAL
                this.vx = (Math.random() - 0.5) * 1.5;
                this.vy = (Math.random() - 0.5) * 1.5;
                this.type = type; 
                this.radius = CELL_RADIUS;
                this.id = Math.random().toString(36).substr(2, 9);
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);

                // Body
                ctx.beginPath();
                ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = (this.type === 'AB') ? '#8e24aa' : '#d32f2f'; 
                ctx.fill();
                
                // 3D visual
                ctx.beginPath();
                ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                ctx.lineWidth = 2;
                ctx.strokeStyle = 'rgba(0,0,0,0.2)';
                ctx.stroke();
                
                // Dimple
                ctx.beginPath();
                ctx.arc(0, 0, this.radius * 0.5, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0,0,0,0.15)';
                ctx.fill();

                // Antigens
                if (this.type === 'A' || this.type === 'AB') {
                    ctx.fillStyle = '#fdd835'; 
                    for (let i = 0; i < 6; i++) {
                        ctx.save();
                        ctx.rotate((Math.PI / 3) * i);
                        ctx.beginPath();
                        ctx.moveTo(this.radius - 2, -4);
                        ctx.lineTo(this.radius + 6, 0);
                        ctx.lineTo(this.radius - 2, 4);
                        ctx.fill();
                        ctx.restore();
                    }
                }
                
                if (this.type === 'B' || this.type === 'AB') {
                    ctx.fillStyle = '#42a5f5';
                    const offset = (this.type === 'AB') ? Math.PI/6 : 0;
                    for (let i = 0; i < 6; i++) {
                        ctx.save();
                        ctx.rotate((Math.PI / 3) * i + offset);
                        ctx.beginPath();
                        ctx.arc(this.radius + 3, 0, 3.5, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.restore();
                    }
                }

                ctx.fillStyle = 'rgba(255,255,255,0.9)';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.type, 0, 0);

                ctx.restore();
            }

            update() {
                // Boundary check using global width/height
                if (this.x < this.radius) { this.x = this.radius; this.vx *= -1; }
                if (this.x > width - this.radius) { this.x = width - this.radius; this.vx *= -1; }
                if (this.y < this.radius) { this.y = this.radius; this.vy *= -1; }
                if (this.y > height - this.radius) { this.y = height - this.radius; this.vy *= -1; }

                this.x += this.vx;
                this.y += this.vy;
                
                this.vx *= 0.98; 
                this.vy *= 0.98;

                // Brownian Motion
                this.vx += (Math.random() - 0.5) * 0.15;
                this.vy += (Math.random() - 0.5) * 0.15;
            }
        }

        class Antibody {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.vx = (Math.random() - 0.5) * 2.0;
                this.vy = (Math.random() - 0.5) * 2.0;
                this.angle = Math.random() * Math.PI * 2;
                
                this.cell1 = null; 
                this.cell2 = null; 
                this.angleOnCell1 = 0; 
            }

            draw() {
                ctx.save();
                
                if (this.cell1 && !this.cell2) {
                    this.x = this.cell1.x + Math.cos(this.angleOnCell1) * (this.cell1.radius + 5);
                    this.y = this.cell1.y + Math.sin(this.angleOnCell1) * (this.cell1.radius + 5);
                    this.angle = this.angleOnCell1 + Math.PI/2;
                } else if (this.cell1 && this.cell2) {
                    this.x = (this.cell1.x + this.cell2.x) / 2;
                    this.y = (this.cell1.y + this.cell2.y) / 2;
                    const dx = this.cell2.x - this.cell1.x;
                    const dy = this.cell2.y - this.cell1.y;
                    this.angle = Math.atan2(dy, dx) + Math.PI/2; 
                }

                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);

                const color = (this.type === 'Anti-A') ? '#fbc02d' : '#1e88e5'; 
                ctx.strokeStyle = color;
                ctx.fillStyle = color;
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';

                ctx.beginPath();
                ctx.moveTo(0, 5); 
                ctx.lineTo(0, -2);
                ctx.lineTo(-5, -8);
                ctx.moveTo(0, -2);
                ctx.lineTo(5, -8);
                ctx.stroke();

                if (this.type === 'Anti-A') {
                    ctx.fillRect(-6, -9, 2, 2); ctx.fillRect(4, -9, 2, 2);
                } else {
                    ctx.beginPath(); ctx.arc(-5, -8, 1.5, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(5, -8, 1.5, 0, Math.PI*2); ctx.fill();
                }

                ctx.restore();
            }

            update() {
                if (!this.cell1 && !this.cell2) {
                    this.x += this.vx;
                    this.y += this.vy;
                    this.angle += 0.02; 
                    
                    if (this.x < 0 || this.x > width) this.vx *= -1;
                    if (this.y < 0 || this.y > height) this.vy *= -1;
                    
                    this.vx *= 0.98;
                    this.vy *= 0.98;
                    
                    // Brownian Motion
                    this.vx += (Math.random() - 0.5) * 0.2;
                    this.vy += (Math.random() - 0.5) * 0.2;
                } 
            }
        }

        // --- LOGIC UTAMA ---

        function addBloodSample(type) {
            const includePlasma = plasmaToggle.checked;
            const centerX = width/2 + (Math.random()-0.5)* (width * 0.4); // Adaptive spawn range
            const centerY = height/2 + (Math.random()-0.5)* (height * 0.4);

            for (let i = 0; i < 6; i++) {
                cells.push(new RedBloodCell(
                    centerX + (Math.random()-0.5)*60, 
                    centerY + (Math.random()-0.5)*60, 
                    type
                ));
            }

            let msg = `+ SDM ${type}`;

            if (includePlasma) {
                let antibodiesToAdd = [];
                if (type === 'A') antibodiesToAdd.push('Anti-B');
                if (type === 'B') antibodiesToAdd.push('Anti-A');
                if (type === 'O') { antibodiesToAdd.push('Anti-A'); antibodiesToAdd.push('Anti-B'); }
                
                let count = 0;
                antibodiesToAdd.forEach(abType => {
                    for(let i=0; i<6; i++) {
                        antibodies.push(new Antibody(
                            centerX + (Math.random()-0.5)*100,
                            centerY + (Math.random()-0.5)*100,
                            abType
                        ));
                    }
                    count++;
                });
                
                if (count > 0) {
                    msg += ` & Plasma`;
                    log(msg, "warning");
                } else {
                    msg += ` (Plasma AB Bersih)`;
                    log(msg, "neutral");
                }
            } else {
                msg += ` (Sel Saja)`;
                log(msg, "success");
            }
        }

        function addReagent(type) {
            for(let i=0; i<15; i++) {
                antibodies.push(new Antibody(
                    Math.random() * width,
                    Math.random() * height,
                    type
                ));
            }
            log(`+ Reagen: ${type}`, "info");
        }

        function resetSimulation() {
            cells = [];
            antibodies = [];
            statusLabel.style.opacity = '0';
            log("=== BERSIH ===", "neutral");
        }

        // --- PHYSICS ---

        function checkCompatibility(antibody, cell) {
            if (antibody.type === 'Anti-A') return (cell.type === 'A' || cell.type === 'AB');
            if (antibody.type === 'Anti-B') return (cell.type === 'B' || cell.type === 'AB');
            return false;
        }

        function resolvePhysics() {
            let reactionCount = 0;

            for (let ab of antibodies) {
                if (ab.cell1 && ab.cell2) {
                    reactionCount++;
                    continue;
                }

                for (let cell of cells) {
                    if (ab.cell1 === cell) continue;
                    if (!checkCompatibility(ab, cell)) continue;

                    let dist;
                    if (!ab.cell1) {
                        const dx = ab.x - cell.x;
                        const dy = ab.y - cell.y;
                        dist = Math.sqrt(dx*dx + dy*dy);
                        if (dist < cell.radius + ANTIBODY_SIZE) {
                            ab.cell1 = cell;
                            ab.angleOnCell1 = Math.atan2(ab.y - cell.y, ab.x - cell.x);
                        }
                    } else {
                        const abX = ab.cell1.x + Math.cos(ab.angleOnCell1) * (ab.cell1.radius + 5);
                        const abY = ab.cell1.y + Math.sin(ab.angleOnCell1) * (ab.cell1.radius + 5);
                        const dx = abX - cell.x;
                        const dy = abY - cell.y;
                        dist = Math.sqrt(dx*dx + dy*dy);
                        if (dist < cell.radius + 8) {
                            ab.cell2 = cell;
                        }
                    }
                }
            }

            for (let ab of antibodies) {
                if (ab.cell1 && ab.cell2) {
                    const c1 = ab.cell1;
                    const c2 = ab.cell2;
                    const dx = c2.x - c1.x;
                    const dy = c2.y - c1.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    const target = c1.radius + c2.radius + 10;

                    if (dist > 0) {
                        const force = (dist - target) * SPRING_STRENGTH;
                        const fx = (dx / dist) * force;
                        const fy = (dy / dist) * force;
                        c1.vx += fx; c1.vy += fy;
                        c2.vx -= fx; c2.vy -= fy;
                    }
                }
            }

            for (let i = 0; i < cells.length; i++) {
                for (let j = i + 1; j < cells.length; j++) {
                    const c1 = cells[i];
                    const c2 = cells[j];
                    const dx = c2.x - c1.x;
                    const dy = c2.y - c1.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    const minDist = c1.radius + c2.radius;

                    if (dist < minDist && dist > 0) {
                        const overlap = minDist - dist;
                        const force = overlap * REPULSION_STRENGTH;
                        const fx = (dx / dist) * force;
                        const fy = (dy / dist) * force;
                        c1.vx -= fx; c1.vy -= fy;
                        c2.vx += fx; c2.vy += fy;
                    }
                }
            }

            if (reactionCount > 2) {
                statusLabel.style.opacity = '1';
            } else {
                statusLabel.style.opacity = '0';
            }
        }

        function animate() {
            ctx.clearRect(0, 0, width, height);
            resolvePhysics();

            antibodies.forEach(ab => {
                if(ab.cell1 && ab.cell2) {
                    const midX = (ab.cell1.x + ab.cell2.x) / 2;
                    const midY = (ab.cell1.y + ab.cell2.y) / 2;
                    
                    const gradient = ctx.createRadialGradient(midX, midY, 0, midX, midY, 45);
                    gradient.addColorStop(0, 'rgba(239, 68, 68, 0.4)'); 
                    gradient.addColorStop(1, 'rgba(239, 68, 68, 0)');   
                    
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(midX, midY, 45, 0, Math.PI*2);
                    ctx.fill();

                    ctx.strokeStyle = 'rgba(253, 224, 71, 0.8)'; 
                    ctx.lineWidth = 4; 
                    ctx.lineCap = 'round';
                    ctx.beginPath();
                    ctx.moveTo(ab.cell1.x, ab.cell1.y);
                    ctx.lineTo(ab.cell2.x, ab.cell2.y);
                    ctx.stroke();
                }
            });

            cells.forEach(c => { c.update(); c.draw(); });
            antibodies.forEach(a => { a.update(); a.draw(); });

            requestAnimationFrame(animate);
        }

        animate();
    </script>
</body>
</html>
