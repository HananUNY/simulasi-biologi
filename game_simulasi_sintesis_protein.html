<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIBOSOME RUSH: Immersive Edition</title>
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            /* Background Stasiun */
            --bg-nucleus: #8e44ad;
            --bg-ribosome: #e67e22;
            --bg-golgi: #27ae60;
            --bg-membrane: #2980b9;
            
            /* Produk/Item */
            --item-mrna: #f1c40f;
            --item-protein: #e74c3c;
            --item-vesicle: #ecf0f1;

            /* UI Colors */
            --p1-color: #ff6b6b;
            --p2-color: #4ecdc4;
            --locked-color: #95a5a6;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body {
            background-color: #2c3e50;
            height: 100vh;
            overflow: hidden;
            color: white;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER & HUD --- */
        #hud {
            height: 80px;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
            border-bottom: 2px solid #fff;
            z-index: 10;
        }

        .score-box {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            width: 150px;
            padding: 10px;
            border-radius: 10px;
        }

        #p1-score-display { background-color: var(--p1-color); color: #fff; }
        #p2-score-display { background-color: var(--p2-color); color: #000; }

        #timer {
            font-size: 2.5rem;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            background: #000;
            padding: 5px 20px;
            border-radius: 5px;
            border: 2px solid #e74c3c;
        }

        /* --- GAME AREA (SPLIT SCREEN) --- */
        #game-area {
            flex: 1;
            display: flex;
            position: relative;
        }

        .player-lane {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            align-items: center;
            position: relative;
            border-right: 2px dashed rgba(255,255,255,0.3);
            background: #34495e;
            transition: background 0.2s;
        }
        .player-lane:last-child { border-right: none; }

        .lane-label {
            position: absolute;
            top: 10px;
            font-size: 2rem;
            opacity: 0.2;
            font-weight: 900;
            text-transform: uppercase;
        }

        /* --- STATIONS --- */
        .station {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s, filter 0.3s;
            border: 4px solid transparent;
        }

        .station:hover { transform: scale(1.05); }
        .station:active { transform: scale(0.95); }

        .station::after {
            content: attr(data-name);
            position: absolute;
            bottom: -25px;
            font-size: 0.8rem;
            font-weight: bold;
            white-space: nowrap;
            text-shadow: 1px 1px 2px black;
        }

        .station-nucleus { background: var(--bg-nucleus); }
        .station-ribosome { background: var(--bg-ribosome); border-radius: 15px; }
        .station-golgi { background: var(--bg-golgi); border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
        .station-membrane { background: var(--bg-membrane); width: 80%; height: 50px; border-radius: 0; border-top: 5px solid #fff; }

        .station.active {
            animation: pulse 1.5s infinite;
            border-color: #fff;
            box-shadow: 0 0 20px rgba(255,255,255,0.6);
            filter: brightness(1.2);
            z-index: 2;
        }

        .station.inactive {
            filter: grayscale(0.8) opacity(0.5);
            cursor: not-allowed;
        }

        /* --- PENALTY --- */
        .player-lane.locked {
            background-color: #381818;
            pointer-events: none;
        }
        .player-lane.locked::before {
            content: "ERROR! (3s)";
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: red;
            font-size: 2rem;
            font-weight: bold;
            border: 4px solid red;
            padding: 20px;
            background: rgba(0,0,0,0.8);
            z-index: 20;
            animation: shake 0.5s;
        }

        /* --- ANIMATIONS --- */
        .conveyor-path {
            position: absolute;
            width: 4px;
            background: rgba(255,255,255,0.1);
            top: 10%; bottom: 10%; z-index: 0;
        }
        .product-anim {
            position: absolute;
            width: 30px; height: 30px;
            border-radius: 50%;
            z-index: 5;
            transition: top 1s ease-in-out;
            pointer-events: none;
        }

        /* --- MINI GAME OVERLAY (IMMERSIVE VIEW) --- */
        #minigame-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .minigame-container {
            background: #34495e;
            width: 800px;
            height: 550px; /* Sedikit diperbesar untuk konten lebih banyak */
            border-radius: 20px;
            border: 4px solid white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        .mg-header {
            padding: 15px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            background: rgba(0,0,0,0.2);
        }

        .mg-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 20px;
            overflow-y: auto; /* Allow scroll if content too long */
        }

        /* --- MINI GAME: TRANSCRIPTION (Nukleus) --- */
        .dna-strand {
            display: flex;
            flex-wrap: wrap; /* AGAR BISA TURUN BARIS JIKA PANJANG */
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            max-width: 100%;
        }
        .base-pair {
            width: 50px; height: 50px;
            background: #fff;
            color: #333;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 5px;
            border-bottom: 4px solid #bdc3c7;
        }
        .base-pair.dna { background: #3498db; color: white; border-color: #2980b9; }
        .base-pair.rna-slot { background: #ecf0f1; border: 2px dashed #95a5a6; cursor: pointer; color: #2c3e50; }
        .base-pair.rna-filled { background: #f1c40f; color: black; border: 2px solid #f39c12; }
        
        .rna-keyboard { display: flex; gap: 20px; margin-top: 10px; }
        .rna-key {
            width: 60px; height: 60px;
            background: #e67e22;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 0 #d35400;
        }
        .rna-key:active { transform: translateY(5px); box-shadow: 0 0 0; }

        /* --- MINI GAME: TRANSLATION (Ribosom) --- */
        .ribosome-bg {
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Ubah ke start agar bisa menumpuk ke bawah */
            padding-top: 20px;
        }
        .mrna-strip {
            display: flex;
            background: #e74c3c;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .codon-box {
            font-family: monospace;
            font-size: 2.5rem;
            letter-spacing: 5px;
            color: white;
            padding: 10px 20px;
            border: 2px solid white;
            min-width: 150px;
            text-align: center;
        }
        .trna-options { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .trna-card {
            background: #27ae60;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            width: 110px;
            transition: 0.2s;
            border-bottom: 5px solid #1e8449;
        }
        .trna-card:hover { transform: scale(1.1); }
        .anticodon { font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; }
        .amino-acid { font-size: 0.8rem; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 5px; }

        /* Visualisasi Rantai Polipeptida */
        .polypeptide-chain {
            display: flex;
            gap: 5px;
            margin-top: 30px;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 50px;
            min-height: 60px;
            min-width: 300px;
            justify-content: center;
            align-items: center;
        }
        .amino-bead {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: #9b59b6;
            border: 2px solid white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            font-weight: bold;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* --- MINI GAME: GOLGI (Packaging) --- */
        .golgi-progress-container {
            width: 80%; height: 40px;
            background: #2c3e50;
            border: 2px solid white;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }
        .golgi-bar {
            width: 0%; height: 100%;
            background: linear-gradient(90deg, #f1c40f, #e67e22);
            transition: width 0.05s linear; /* Smooth transition */
        }
        .target-zone {
            position: absolute; top: 0; bottom: 0;
            background: rgba(39, 174, 96, 0.5);
            border-left: 2px solid #2eff84;
            border-right: 2px solid #2eff84;
        }
        .golgi-btn {
            margin-top: 30px;
            padding: 20px 50px;
            font-size: 1.5rem;
            background: #8e44ad;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 5px 0 #6c3483;
        }

        /* --- MINI GAME: MEMBRANE (Exocytosis) --- */
        .membrane-wall {
            width: 100%; height: 20px;
            background: #2980b9;
            position: absolute; bottom: 50px;
        }
        .membrane-gate {
            width: 100px; height: 20px;
            background: #e74c3c; /* Closed color */
            position: absolute; left: 50%; transform: translateX(-50%);
            transition: background 0.2s;
        }
        .vesicle-ball {
            width: 50px; height: 50px;
            background: #ecf0f1;
            border-radius: 50%;
            position: absolute; top: 50px; left: 10%;
            transition: left 0.1s linear, top 0.5s ease-in;
        }

        /* --- SCREENS --- */
        #start-screen, #game-over-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            text-align: center;
        }
        .btn-main {
            padding: 15px 40px;
            font-size: 1.5rem;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 5px 0 #219150;
        }
        .btn-main:active { transform: translateY(4px); box-shadow: 0 1px 0 #219150; }

        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255,255,255,0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0); } }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 10% { transform: translate(-1px, -2px); } 20% { transform: translate(-3px, 0px); } 30% { transform: translate(3px, 2px); } 40% { transform: translate(1px, -1px); } 50% { transform: translate(-1px, 2px); } 60% { transform: translate(-3px, 1px); } 70% { transform: translate(3px, 1px); } 80% { transform: translate(-1px, -1px); } 90% { transform: translate(1px, 2px); } 100% { transform: translate(1px, -2px); } }

    </style>
</head>
<body>

    <!-- START SCREEN -->
    <div id="start-screen">
        <h1 style="font-size: 3rem; margin-bottom: 10px; color: #f1c40f;">RIBOSOME RUSH</h1>
        <h2 style="color:white; margin-bottom:20px;">EDISI IMERSIF & EXTENDED</h2>
        <p style="font-size: 1.2rem; max-width: 600px; margin-bottom: 30px;">
            Masuk ke dalam sel dan kendalikan prosesnya!<br>
            1. <b>Nukleus:</b> Pasangkan basa DNA Panjang (8-10 Basa).<br>
            2. <b>Ribosom:</b> Rangkai Asam Amino (3-5 Kodon).<br>
            3. <b>Golgi:</b> Lipat protein (Timing).<br>
            4. <b>Membran:</b> Luncurkan vesikula.
        </p>
        <button class="btn-main" onclick="initGame()">MULAI SIMULASI (3 Menit)</button>
    </div>

    <!-- GAME OVER SCREEN -->
    <div id="game-over-screen" style="display: none;">
        <h1 style="font-size: 3rem; color: #e74c3c;">WAKTU HABIS!</h1>
        <div style="font-size: 2rem; margin: 20px;" id="winner-text">Pemenang: ???</div>
        <div style="display: flex; gap: 20px; margin-bottom: 30px;">
            <div class="score-box" id="final-p1" style="background: var(--p1-color);">P1: 0</div>
            <div class="score-box" id="final-p2" style="background: var(--p2-color);">P2: 0</div>
        </div>
        <button class="btn-main" onclick="location.reload()">MAIN LAGI</button>
    </div>

    <!-- HUD -->
    <div id="hud">
        <div class="score-box" id="p1-score-display">P1: 0</div>
        <div id="timer">03:00</div>
        <div class="score-box" id="p2-score-display">P2: 0</div>
    </div>

    <!-- GAME AREA -->
    <div id="game-area">
        <!-- PLAYER 1 LANE -->
        <div class="player-lane" id="lane-p1">
            <div class="lane-label" style="color: var(--p1-color);">PLAYER 1</div>
            <div class="conveyor-path"></div>
            
            <div class="station station-nucleus" id="p1-s0" data-name="Nukleus" onclick="handleStationClick(1, 0)"></div>
            <div class="station station-ribosome" id="p1-s1" data-name="Ribosom" onclick="handleStationClick(1, 1)"></div>
            <div class="station station-golgi" id="p1-s2" data-name="Golgi" onclick="handleStationClick(1, 2)"></div>
            <div class="station station-membrane" id="p1-s3" data-name="Membran" onclick="handleStationClick(1, 3)"></div>
        </div>

        <!-- PLAYER 2 LANE -->
        <div class="player-lane" id="lane-p2">
            <div class="lane-label" style="color: var(--p2-color);">PLAYER 2</div>
            <div class="conveyor-path"></div>

            <div class="station station-nucleus" id="p2-s0" data-name="Nukleus" onclick="handleStationClick(2, 0)"></div>
            <div class="station station-ribosome" id="p2-s1" data-name="Ribosom" onclick="handleStationClick(2, 1)"></div>
            <div class="station station-golgi" id="p2-s2" data-name="Golgi" onclick="handleStationClick(2, 2)"></div>
            <div class="station station-membrane" id="p2-s3" data-name="Membran" onclick="handleStationClick(2, 3)"></div>
        </div>
    </div>

    <!-- IMMERSIVE MINI GAME OVERLAY -->
    <div id="minigame-overlay">
        <div class="minigame-container" id="minigame-container">
            <div class="mg-header" id="mg-title">NUCLEUS: TRANSCRIPTION</div>
            <div class="mg-content" id="mg-content">
                <!-- Content injected dynamically -->
            </div>
        </div>
    </div>

    <script>
        // --- GAME STATE ---
        let gameActive = false;
        let timeRemaining = 180;
        let timerInterval;
        let activePlayer = null; // Who is playing the mini-game
        let activeStage = null;  // Which stage is currently being played

        const players = {
            1: { score: 0, currentStage: 0, locked: false },
            2: { score: 0, currentStage: 0, locked: false }
        };

        // --- MINI GAME DATA VARIABLES ---
        let mgState = {}; // Holds temporary state for current mini game

        // --- INITIALIZATION ---
        function initGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-over-screen').style.display = 'none';
            gameActive = true;
            timeRemaining = 180;
            players[1] = { score: 0, currentStage: 0, locked: false };
            players[2] = { score: 0, currentStage: 0, locked: false };
            updateScoreboard();
            updateStationsUI();
            clearInterval(timerInterval);
            timerInterval = setInterval(gameLoop, 1000);
            updateTimerDisplay();
        }

        function gameLoop() {
            if (!gameActive) return;
            timeRemaining--;
            updateTimerDisplay();
            if (timeRemaining <= 0) endGame();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timer').innerText = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // --- STATION INTERACTION ---
        function handleStationClick(playerId, stationIndex) {
            if (!gameActive) return;
            const player = players[playerId];
            if (player.locked) return;
            if (stationIndex !== player.currentStage) return;

            // Start Immersive Mini Game
            activePlayer = playerId;
            activeStage = stationIndex;
            launchMiniGame(stationIndex);
        }

        // --- MINI GAME LAUNCHER ---
        function launchMiniGame(stageIndex) {
            const overlay = document.getElementById('minigame-overlay');
            const container = document.getElementById('minigame-container');
            const title = document.getElementById('mg-title');
            const content = document.getElementById('mg-content');
            
            overlay.style.display = 'flex';
            content.innerHTML = ''; // Clear previous

            // Set Color Theme based on Player
            container.style.borderColor = activePlayer === 1 ? 'var(--p1-color)' : 'var(--p2-color)';

            switch(stageIndex) {
                case 0: // NUCLEUS (TRANSCRIPTION)
                    title.innerText = "NUKLEUS: TRANSKRIPSI DNA (PANJANG)";
                    initTranscriptionGame(content);
                    break;
                case 1: // RIBOSOME (TRANSLATION)
                    title.innerText = "RIBOSOM: TRANSLASI (MULTIPLE KODON)";
                    initTranslationGame(content);
                    break;
                case 2: // GOLGI (PACKAGING)
                    title.innerText = "BADAN GOLGI: LIPAT PROTEIN (Timing)";
                    initGolgiGame(content);
                    break;
                case 3: // MEMBRANE (SECRETION)
                    title.innerText = "MEMBRAN SEL: EKSOSITOSIS";
                    initMembraneGame(content);
                    break;
            }
        }

        // --- 1. TRANSCRIPTION GAME (Nukleus - UPDATED LONG) ---
        // Logic: Match 8-10 DNA bases to RNA
        function initTranscriptionGame(container) {
            // Generate Random DNA Sequence (8-10 bases)
            const length = 8 + Math.floor(Math.random() * 3); // 8, 9, or 10
            const bases = ['A', 'T', 'G', 'C'];
            const template = Array(length).fill(0).map(() => bases[Math.floor(Math.random() * bases.length)]);
            mgState = { template: template, input: [], required: template.length };

            let html = `<div style="margin-bottom:5px; font-weight:bold;">DNA TEMPLATE:</div>`;
            html += `<div class="dna-strand">`;
            template.forEach(b => html += `<div class="base-pair dna">${b}</div>`);
            html += `</div>`;
            
            html += `<div style="margin-bottom:5px; font-weight:bold; margin-top:10px;">mRNA BARU:</div>`;
            html += `<div class="dna-strand" id="rna-slots">`;
            for(let i=0; i<length; i++) html += `<div class="base-pair rna-slot" id="slot-${i}">?</div>`;
            html += `</div>`;

            html += `<div class="rna-keyboard">
                <button class="rna-key" onclick="typeRNA('A')">A</button>
                <button class="rna-key" onclick="typeRNA('U')">U</button>
                <button class="rna-key" onclick="typeRNA('G')">G</button>
                <button class="rna-key" onclick="typeRNA('C')">C</button>
            </div>`;
            html += `<div style="margin-top:10px; font-style:italic;">Pasangan: A-U, T-A, G-C, C-G</div>`;

            container.innerHTML = html;
        }

        window.typeRNA = function(base) {
            if (mgState.input.length < mgState.required) {
                mgState.input.push(base);
                updateRNASlots();
                if (mgState.input.length === mgState.required) checkTranscription();
            }
        };

        function updateRNASlots() {
            for(let i=0; i<mgState.required; i++) {
                const el = document.getElementById(`slot-${i}`);
                if (mgState.input[i]) {
                    el.innerText = mgState.input[i];
                    el.classList.add('rna-filled');
                    el.classList.remove('rna-slot');
                }
            }
        }

        function checkTranscription() {
            let correct = true;
            for(let i=0; i<mgState.required; i++) {
                const dna = mgState.template[i];
                const rna = mgState.input[i];
                if (dna === 'A' && rna !== 'U') correct = false;
                if (dna === 'T' && rna !== 'A') correct = false;
                if (dna === 'G' && rna !== 'C') correct = false;
                if (dna === 'C' && rna !== 'G') correct = false;
            }

            if (correct) closeMiniGame(true);
            else {
                const slots = document.getElementById('rna-slots');
                slots.style.animation = "shake 0.5s";
                setTimeout(() => {
                    mgState.input = [];
                    // Reset UI
                    for(let i=0; i<mgState.required; i++) {
                        const el = document.getElementById(`slot-${i}`);
                        el.innerText = "?";
                        el.classList.remove('rna-filled');
                        el.classList.add('rna-slot');
                    }
                    slots.style.animation = "";
                }, 500);
            }
        }

        // --- 2. TRANSLATION GAME (Ribosom - UPDATED MULTIPLE CODONS) ---
        // Logic: Queue of 3-5 codons
        function initTranslationGame(container) {
            const geneticCode = [
                { codon: "AUG", anti: "UAC", aa: "Met" },
                { codon: "UUU", anti: "AAA", aa: "Phe" },
                { codon: "GGG", anti: "CCC", aa: "Gly" },
                { codon: "CCC", anti: "GGG", aa: "Pro" },
                { codon: "AAA", anti: "UUU", aa: "Lys" },
                { codon: "GCG", anti: "CGC", aa: "Ala" },
                { codon: "UAC", anti: "AUG", aa: "Tyr" }
            ];

            // Generate sequence of 3-5 codons
            const numCodons = 3 + Math.floor(Math.random() * 3); // 3, 4, 5
            const sequence = [];
            for(let i=0; i<numCodons; i++) {
                sequence.push(geneticCode[Math.floor(Math.random() * geneticCode.length)]);
            }

            mgState = { 
                sequence: sequence, 
                currentIndex: 0, 
                total: numCodons,
                builtChain: [] 
            };

            renderTranslationStep(container);
        }

        function renderTranslationStep(container) {
            const target = mgState.sequence[mgState.currentIndex];
            
            // Generate wrong options for current codon
            let options = [target];
            // Hacky genetic code access for distractors
            const geneticCodeAll = [
                { codon: "AUG", anti: "UAC", aa: "Met" }, { codon: "UUU", anti: "AAA", aa: "Phe" },
                { codon: "GGG", anti: "CCC", aa: "Gly" }, { codon: "CCC", anti: "GGG", aa: "Pro" },
                { codon: "AAA", anti: "UUU", aa: "Lys" }, { codon: "GCG", anti: "CGC", aa: "Ala" },
                { codon: "UAC", anti: "AUG", aa: "Tyr" }
            ];
            while(options.length < 3) {
                const rand = geneticCodeAll[Math.floor(Math.random() * geneticCodeAll.length)];
                if (!options.find(o => o.anti === rand.anti)) options.push(rand);
            }
            options = options.sort(() => Math.random() - 0.5);

            let html = `<div class="ribosome-bg">`;
            
            // Progress Indicator
            html += `<div style="font-weight:bold; margin-bottom:10px; color:#f1c40f;">Kodon ke-${mgState.currentIndex + 1} dari ${mgState.total}</div>`;

            // Current Codon
            html += `<div class="mrna-strip"><div class="codon-box">${target.codon}</div></div>`;
            
            // Options
            html += `<div style="margin-bottom:10px;">Pilih tRNA (Antikodon):</div>`;
            html += `<div class="trna-options">`;
            options.forEach(opt => {
                html += `<div class="trna-card" onclick="checkTranslationStep('${opt.anti}', '${target.anti}', '${opt.aa}')">
                    <div class="anticodon">${opt.anti}</div>
                    <div class="amino-acid">${opt.aa}</div>
                </div>`;
            });
            html += `</div>`;

            // Polypeptide Chain Visualization
            html += `<div class="polypeptide-chain" id="chain-viz">`;
            if (mgState.builtChain.length === 0) {
                html += `<span style="opacity:0.5; font-style:italic;">Rantai protein akan muncul di sini...</span>`;
            } else {
                mgState.builtChain.forEach(aa => {
                    html += `<div class="amino-bead">${aa}</div>`;
                });
            }
            html += `</div>`;
            html += `</div>`; // end bg

            container.innerHTML = html;
        }

        window.checkTranslationStep = function(selected, correct, aaName) {
            if (selected === correct) {
                // Correct!
                mgState.builtChain.push(aaName);
                mgState.currentIndex++;

                if (mgState.currentIndex >= mgState.total) {
                    // Finished all codons
                    closeMiniGame(true);
                } else {
                    // Next codon
                    const container = document.getElementById('mg-content');
                    renderTranslationStep(container);
                }
            } else {
                // Wrong! Immediate fail for challenge
                closeMiniGame(false);
            }
        };

        // --- 3. GOLGI GAME (Packaging) - Same as previous ---
        function initGolgiGame(container) {
            mgState = { moving: true, pos: 0, dir: 1 };
            const targetLeft = 30 + Math.floor(Math.random() * 40);
            const targetWidth = 25; 
            mgState.targetStart = targetLeft;
            mgState.targetEnd = targetLeft + targetWidth;

            let html = `<h3 style="margin-bottom:20px;">Tekan "LIPAT" saat meteran di area HIJAU</h3>`;
            html += `<div class="golgi-progress-container">
                <div class="target-zone" style="left: ${targetLeft}%; width: ${targetWidth}%;"></div>
                <div class="golgi-bar" id="golgi-bar"></div>
            </div>`;
            html += `<button class="golgi-btn" onclick="checkGolgi()">LIPAT PROTEIN!</button>`;
            container.innerHTML = html;

            mgState.interval = setInterval(() => {
                if (!mgState.moving) return;
                mgState.pos += 0.5 * mgState.dir; 
                if (mgState.pos >= 100) { mgState.pos = 100; mgState.dir = -1; } 
                else if (mgState.pos <= 0) { mgState.pos = 0; mgState.dir = 1; }
                document.getElementById('golgi-bar').style.width = mgState.pos + "%";
            }, 10);
        }

        window.checkGolgi = function() {
            clearInterval(mgState.interval);
            mgState.moving = false;
            if (mgState.pos >= (mgState.targetStart - 3) && mgState.pos <= (mgState.targetEnd + 3)) {
                closeMiniGame(true);
            } else {
                closeMiniGame(false);
            }
        };

        // --- 4. MEMBRANE GAME (Exocytosis) - Same as previous ---
        function initMembraneGame(container) {
            mgState = { open: false };
            let html = `<h3 style="margin-bottom:20px;">Tekan "KELUARKAN" saat gerbang TERBUKA (Hijau)</h3>`;
            html += `<div style="position:relative; width:100%; height:200px; background:#34495e; border:2px solid #fff;">
                <div class="vesicle-ball" id="vesicle"></div>
                <div class="membrane-wall"></div>
                <div class="membrane-gate" id="gate"></div>
            </div>`;
            html += `<button class="golgi-btn" style="background:#2980b9; margin-top:20px;" onclick="checkMembrane()">KELUARKAN VESIKULA</button>`;
            container.innerHTML = html;
            mgState.interval = setInterval(() => {
                const gate = document.getElementById('gate');
                if(!gate) return;
                mgState.open = !mgState.open;
                gate.style.background = mgState.open ? "#2ecc71" : "#e74c3c";
                gate.style.height = mgState.open ? "5px" : "20px";
            }, 1000 + Math.random() * 1000);
        }

        window.checkMembrane = function() {
            clearInterval(mgState.interval);
            const vesicle = document.getElementById('vesicle');
            vesicle.style.left = "45%";
            vesicle.style.top = "160px";
            setTimeout(() => {
                if (mgState.open) closeMiniGame(true);
                else closeMiniGame(false);
            }, 500);
        };


        // --- FINISH MINI GAME ---
        function closeMiniGame(success) {
            clearInterval(mgState.interval); // Cleanup
            document.getElementById('minigame-overlay').style.display = 'none';
            if (success) handleSuccess();
            else handleFailure();
            activePlayer = null; activeStage = null;
        }

        function handleSuccess() {
            const player = players[activePlayer];
            playProductAnimation(activePlayer, player.currentStage);
            player.currentStage++;
            if (player.currentStage > 3) {
                player.score++;
                player.currentStage = 0;
                updateScoreboard();
            }
            updateStationsUI();
        }

        function handleFailure() {
            const player = players[activePlayer];
            player.locked = true;
            const lane = document.getElementById(`lane-p${activePlayer}`);
            lane.classList.add('locked');
            setTimeout(() => {
                player.locked = false;
                lane.classList.remove('locked');
            }, 3000);
        }

        // --- SHARED UTILS ---
        function updateStationsUI() {
            for (let pid = 1; pid <= 2; pid++) {
                const current = players[pid].currentStage;
                for (let s = 0; s <= 3; s++) {
                    const el = document.getElementById(`p${pid}-s${s}`);
                    el.classList.remove('active', 'inactive');
                    if (s === current) {
                        el.classList.add('active'); el.style.opacity = "1";
                    } else {
                        el.classList.add('inactive');
                    }
                }
            }
        }

        function playProductAnimation(playerId, fromStage) {
            if (fromStage >= 3) return;
            const startEl = document.getElementById(`p${playerId}-s${fromStage}`);
            const endEl = document.getElementById(`p${playerId}-s${fromStage+1}`);
            const particle = document.createElement('div');
            particle.className = 'product-anim';
            if (fromStage === 0) particle.style.background = 'var(--item-mrna)';
            else if (fromStage === 1) particle.style.background = 'var(--item-protein)';
            else particle.style.background = 'var(--item-vesicle)';

            const lane = document.getElementById(`lane-p${playerId}`);
            lane.appendChild(particle);
            const startRect = startEl.getBoundingClientRect();
            const laneRect = lane.getBoundingClientRect();
            particle.style.top = (startRect.top - laneRect.top + 30) + 'px';
            particle.style.left = (startRect.left - laneRect.left + 30) + 'px';

            requestAnimationFrame(() => {
                const endRect = endEl.getBoundingClientRect();
                particle.style.top = (endRect.top - laneRect.top + 30) + 'px';
            });
            setTimeout(() => particle.remove(), 1000);
        }

        function updateScoreboard() {
            document.getElementById('p1-score-display').innerText = `P1: ${players[1].score}`;
            document.getElementById('p2-score-display').innerText = `P2: ${players[2].score}`;
        }

        function endGame() {
            gameActive = false;
            clearInterval(timerInterval);
            const p1Score = players[1].score;
            const p2Score = players[2].score;
            let winner = "SERI!";
            if (p1Score > p2Score) winner = "PEMENANG: PLAYER 1";
            if (p2Score > p1Score) winner = "PEMENANG: PLAYER 2";
            document.getElementById('winner-text').innerText = winner;
            document.getElementById('final-p1').innerText = `P1: ${p1Score}`;
            document.getElementById('final-p2').innerText = `P2: ${p2Score}`;
            document.getElementById('game-over-screen').style.display = 'flex';
        }

    </script>
</body>
</html>
