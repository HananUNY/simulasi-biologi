<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulasi Dinamika Hutan & Banjir</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --panel-color: #1e293b;
            --text-color: #e2e8f0;
            --accent-color: #3b82f6;
            --danger-color: #ef4444;
            --success-color: #22c55e;
            --forest-color: #15803d;
            --deforest-color: #a16207;
            --natural-color: #64748b;
            --village-color: #334155;
            --night-overlay: rgba(2, 6, 23, 0.6);
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 360px 1fr;
            width: 100%;
            height: 100%;
        }

        .sidebar {
            background-color: var(--panel-color);
            padding: 15px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #334155;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            overflow-y: auto;
            z-index: 10;
            position: relative;
        }

        h1 { font-size: 1.1rem; margin-bottom: 2px; color: var(--accent-color); }
        h2 { font-size: 0.8rem; font-weight: normal; margin-bottom: 15px; color: #94a3b8; }

        .time-widget {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #475569;
            text-align: center;
        }
        .time-display {
            font-size: 1.2rem;
            font-weight: bold;
            font-family: monospace;
            color: #fbbf24;
        }
        .day-display {
            font-size: 0.8rem;
            color: #94a3b8;
        }
        .weather-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        /* Speed Control Buttons */
        .speed-controls {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
            border-top: 1px solid #334155;
            padding-top: 8px;
        }
        .btn-speed {
            padding: 4px 10px;
            font-size: 0.75rem;
            background: transparent;
            border: 1px solid #475569;
            color: #94a3b8;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-speed:hover { background: rgba(255,255,255,0.1); }
        .btn-speed.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            font-weight: bold;
        }

        .control-group {
            margin-bottom: 15px;
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
        }

        label { display: block; font-size: 0.8rem; margin-bottom: 5px; font-weight: 600; }
        .sub-label { font-size: 0.7rem; color: #94a3b8; margin-bottom: 5px; display: block; line-height: 1.2; }
        
        input[type="range"] { width: 100%; cursor: pointer; accent-color: var(--accent-color); height: 6px; }
        input[type="range"].restore-slider { accent-color: var(--success-color); }
        input[type="range"].logging-slider { accent-color: var(--danger-color); }
        input[type="range"].natural-slider { accent-color: #f59e0b; }

        .soil-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.8rem;
        }

        input[type="checkbox"] {
            accent-color: var(--accent-color);
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            background-color: #334155;
            color: white;
            border: 1px solid #475569;
            font-size: 0.85rem;
            cursor: pointer;
        }
        select:disabled { opacity: 0.5; cursor: not-allowed; }
        select:focus { outline: 2px solid var(--accent-color); }

        .value-display { float: right; font-size: 0.8rem; }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-top: 8px;
            width: 100%;
            text-align: center;
            box-sizing: border-box;
        }
        .status-safe { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid #22c55e; }
        .status-warning { background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 1px solid #fbbf24; }
        .status-danger { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid #ef4444; }

        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; margin-top: 5px; }
        button {
            flex: 1; padding: 8px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: bold; transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-outline { background-color: transparent; border: 1px solid #475569; color: #cbd5e1; }

        .stats-panel {
            margin-top: auto;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #334155;
        }

        .stat-card { margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .stat-label { font-size: 0.75rem; color: #94a3b8; }
        .stat-value { font-size: 0.9rem; font-weight: bold; font-family: monospace; }
        
        .main-view {
            position: relative;
            background-color: #020617;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        canvas#simCanvas {
            box-shadow: 0 0 30px rgba(0,0,0,0.6);
            border-radius: 4px;
            border: 1px solid #334155;
            max-height: 95vh;
            max-width: 100%;
        }

        .chart-container {
            margin-top: 8px;
            margin-bottom: 8px;
        }
        .chart-title { font-size: 0.7rem; color: #94a3b8; margin-bottom: 2px; display: flex; justify-content: space-between;}
        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 70px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 4px;
            overflow: hidden;
        }
        canvas.mini-chart { width: 100%; height: 100%; display: block; }
        
        .legend {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            font-size: 0.7rem;
            margin-top: 5px;
        }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 6px; height: 6px; border-radius: 50%; }
        .dot.forest { background: var(--forest-color); }
        .dot.deforest { background: var(--deforest-color); }
        .dot.restoring { background: #4ade80; animation: pulse 1s infinite; }

        /* ATTRIBUTION FOOTER */
        .attribution {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #334155;
            font-size: 0.65rem;
            color: #64748b;
            text-align: center;
            line-height: 1.5;
        }
        .attribution strong {
            color: #94a3b8;
        }

        /* MODAL STYLES */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--panel-color);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal h2 {
            color: var(--accent-color);
            margin-top: 0;
            font-size: 1.4rem;
        }
        .modal p {
            color: #cbd5e1;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 25px;
        }
        .modal-btn {
            background-color: var(--accent-color);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
        }
        .modal-btn:hover { background-color: #2563eb; }
        
    </style>
</head>
<body>

<!-- MODAL DISCLAIMER -->
<div id="introModal" class="modal">
    <div class="modal-content">
        <h2>‚ÑπÔ∏è Perhatian </h2>
        <p>
            Simulasi ini adalah <strong>model penyederhanaan</strong> (abstraksi) untuk tujuan pendidikan semata. Perilaku hidrologi, ekosistem, dan cuaca di dunia nyata jauh lebih kompleks dan dipengaruhi oleh ribuan variabel lain yang tidak tercakup di sini.
        </p>
        <p>
            Visualisasi ini bertujuan memberikan gambaran logis tentang hubungan sebab-akibat antara tutupan lahan, jenis tanah, dan risiko banjir berdasarkan parameter yang Anda atur.
        </p>
        <button id="btnUnderstand" class="modal-btn">Saya Paham & Lanjutkan</button>
    </div>
</div>

<div class="container">
    <aside class="sidebar">
        <h1>Monitor Hulu DAS</h1>
        <h2>Dinamika Vegetasi & Hidrologi</h2>

        <!-- TIME WIDGET -->
        <div class="time-widget">
            <div id="weatherIcon" class="weather-icon">‚òÄÔ∏è</div>
            <div id="timeDisplay" class="time-display">12:00</div>
            <div id="dayDisplay" class="day-display">Hari Ke-1</div>
            <div style="font-size: 0.7rem; color: #4ade80; margin-top: 5px;" id="evapoStatus">
                Evapotranspirasi: Tinggi
            </div>
            
            <!-- Speed Control Buttons -->
            <div class="speed-controls">
                <button class="btn-speed active" id="spd1" onclick="setSimSpeed(1, this)">1x</button>
                <button class="btn-speed" id="spd2" onclick="setSimSpeed(2, this)">2x</button>
                <button class="btn-speed" id="spd5" onclick="setSimSpeed(5, this)">5x</button>
            </div>
        </div>

        <div class="control-group">
            <label style="color: #f87171;">
                Laju Deforestasi (Manusia)
                <span id="loggingVal" class="value-display" style="color:#f87171">Rendah</span>
            </label>
            <span class="sub-label">Kecepatan penebangan/pembukaan lahan</span>
            <input type="range" class="logging-slider" id="loggingSlider" min="0" max="100" value="10">

            <!-- New Control for Pattern -->
            <label style="margin-top: 8px;">Pola Penebangan</label>
            <select id="deforestPattern">
                <option value="random">Acak (Selektif)</option>
                <option value="organized">Sistematis (Blok Besar)</option>
            </select>

            <label style="color: #f59e0b; margin-top:10px;">
                Gangguan Alam (Bencana)
                <span id="naturalVal" class="value-display" style="color:#f59e0b">Jarang</span>
            </label>
            <span class="sub-label">Kebakaran, Angin Kencang, Longsor (Jarang)</span>
            <input type="range" class="natural-slider" id="naturalSlider" min="0" max="100" value="0">

            <label style="color: #4ade80; margin-top:10px;">
                Laju Restorasi (Suksesi)
                <span id="restoreVal" class="value-display" style="color:#4ade80">Rendah</span>
            </label>
            <span class="sub-label">Kecepatan pemulihan vegetasi alami</span>
            <input type="range" class="restore-slider" id="restoreSlider" min="0" max="100" value="10">
        </div>
        
        <div class="control-group">
            <label>Faktor Geologi (Tanah)</label>
            <span class="sub-label">Simulasi daya serap & kejenuhan</span>
            
            <div class="soil-controls">
                <div class="toggle-row">
                    <span>Aktifkan Variabel Tanah</span>
                    <input type="checkbox" id="soilToggle" checked>
                </div>
                
                <select id="soilTypeSelect">
                    <option value="clay">Tanah Liat (Cepat Jenuh)</option>
                    <option value="loam" selected>Tanah Gembur (Sedang)</option>
                    <option value="sandy">Tanah Berpasir (Poros)</option>
                </select>
            </div>
            <!-- Indikator Kejenuhan -->
            <div style="margin-top:10px;">
                <label style="font-size:0.7rem; color:#94a3b8;">Rata-rata Kejenuhan Tanah (Saturation)</label>
                <div style="width:100%; height:6px; background:#334155; border-radius:3px; overflow:hidden;">
                    <div id="saturationBar" style="width:0%; height:100%; background:#60a5fa; transition:width 0.2s;"></div>
                </div>
            </div>
        </div>

        <div class="control-group">
            <label>
                Curah Hujan
                <span id="rainVal" class="value-display" style="color:var(--accent-color)">Gerimis</span>
            </label>
            <input type="range" id="rainSlider" min="0" max="100" value="15">
        </div>

        <div class="btn-group">
            <button id="btnStart" class="btn-primary">Mulai Simulasi</button>
            <button id="btnReset" class="btn-outline">Reset</button>
        </div>

        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-label">Tutupan Hutan</div>
                <div class="stat-value" id="forestCoverText">100%</div>
                <div id="ecoStatus" class="status-badge status-safe" style="width:auto; margin:0;">STABIL</div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">
                    <span>Grafik Luasan Lahan</span>
                    <span style="color:#15803d; font-weight:bold;">Hutan</span> vs <span style="color:#a16207; font-weight:bold;">Gundul</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="landChart" class="mini-chart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">
                    <span>Hidrograf Banjir (Desa)</span>
                    <span id="floodLevelText" style="color:#3b82f6; font-weight:bold;">0 cm</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="floodChart" class="mini-chart"></canvas>
                </div>
            </div>
            
            <div class="legend">
                <div class="legend-item"><div class="dot forest"></div> Hutan</div>
                <div class="legend-item"><div class="dot deforest"></div> Gundul</div>
                <div class="legend-item"><div class="dot" style="background:#0f172a; border:1px solid #60a5fa"></div> Gelap = Jenuh Air</div>
            </div>
        </div>

        <!-- NEW: ATTRIBUTION FOOTER -->
        <div class="attribution">
            Coding oleh <strong>Gemini AI</strong><br>
            Penyempurnaan dan Prompt oleh <strong>Hanan Dimas Prasetya</strong>
        </div>
    </aside>

    <main class="main-view">
        <canvas id="simCanvas"></canvas>
    </main>
</div>

<script>
    /**
     * KONFIGURASI & VARIABEL GLOBAL
     */
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    
    // Grid Setup
    const COLS = 40;
    const ROWS = 40;
    const CELL_SIZE = 15; 
    const WIDTH = COLS * CELL_SIZE;
    const HEIGHT = ROWS * CELL_SIZE;
    canvas.width = WIDTH;
    canvas.height = HEIGHT;
    
    // Tipe Sel
    const TYPE_FOREST = 0;
    const TYPE_DEFOREST = 1;
    const TYPE_NATURAL = 2; // Batu/Alami
    const TYPE_VILLAGE = 3;

    // Warna Dasar
    const COLOR_FOREST = '#15803d';
    const COLOR_DEFOREST = '#a16207';
    const COLOR_NATURAL = '#64748b';
    const COLOR_VILLAGE = '#334155';
    const COLOR_WATER = '#60a5fa';
    
    // Variabel Simulasi
    let grid = [];
    let particles = [];
    let isRunning = false;
    let animationId;
    let floodLevel = 0; 
    let frameCount = 0; 

    // Time System Variables
    let simTimeMinutes = 360; // Start at 06:00
    let dayCount = 1;
    const BASE_MINS_PER_FRAME = 5; // Base speed: 5 mins per frame (~5 secs per day)
    let simSpeedMultiplier = 1; // 1x, 2x, 5x
    let isDaytime = true;
    
    // Statistik Lahan
    let stats = { forest: 0, deforest: 0, natural: 0, total: 0 };
    let avgSaturation = 0;

    // Input Parameters
    let loggingProb = 0.002; 
    let naturalProb = 0.0; // New: Gangguan Alam
    let restoreProb = 0.002; 
    let rainIntensity = 15; 
    let soilType = 'loam'; 
    let useSoilVar = true;
    let deforestPattern = 'random'; // 'random' or 'organized'
    
    // DOM Elements
    const sliderLogging = document.getElementById('loggingSlider');
    const labelLogging = document.getElementById('loggingVal');
    const sliderNatural = document.getElementById('naturalSlider');
    const labelNatural = document.getElementById('naturalVal');
    const sliderRestore = document.getElementById('restoreSlider');
    const labelRestore = document.getElementById('restoreVal');
    const selectPattern = document.getElementById('deforestPattern');

    const soilSelect = document.getElementById('soilTypeSelect');
    const soilToggle = document.getElementById('soilToggle');
    const saturationBar = document.getElementById('saturationBar');
    const ecoStatus = document.getElementById('ecoStatus');
    const sliderRain = document.getElementById('rainSlider');
    const labelRain = document.getElementById('rainVal');
    const btnStart = document.getElementById('btnStart');
    const btnReset = document.getElementById('btnReset');
    const textFlood = document.getElementById('floodLevelText');
    const textForest = document.getElementById('forestCoverText');
    
    // Time UI
    const timeDisplay = document.getElementById('timeDisplay');
    const dayDisplay = document.getElementById('dayDisplay');
    const weatherIcon = document.getElementById('weatherIcon');
    const evapoStatus = document.getElementById('evapoStatus');

    // Modal UI
    const modal = document.getElementById('introModal');
    const btnUnderstand = document.getElementById('btnUnderstand');

    // --- MODAL LOGIC ---
    btnUnderstand.addEventListener('click', () => {
        modal.style.display = 'none';
        // Auto start simulation if desired, or let user click start
        // isRunning = true; 
        // loop();
    });

    // --- CHARTING SYSTEM ---
    const floodCanvas = document.getElementById('floodChart');
    const floodCtx = floodCanvas.getContext('2d');
    let floodHistory = new Array(80).fill(0); 
    const MAX_FLOOD_Y = 2000; 

    const landCanvas = document.getElementById('landChart');
    const landCtx = landCanvas.getContext('2d');
    let landHistory = new Array(80).fill({forest: 1, deforest: 0});

    function resizeCharts() {
        floodCanvas.width = floodCanvas.parentElement.offsetWidth;
        floodCanvas.height = floodCanvas.parentElement.offsetHeight;
        landCanvas.width = landCanvas.parentElement.offsetWidth;
        landCanvas.height = landCanvas.parentElement.offsetHeight;
    }

    function updateCharts() {
        if (frameCount % 5 !== 0) return;
        resizeCharts();

        // Flood Chart
        floodHistory.push(floodLevel);
        floodHistory.shift();
        const fw = floodCanvas.width;
        const fh = floodCanvas.height;
        floodCtx.clearRect(0, 0, fw, fh);
        floodCtx.strokeStyle = '#1e293b';
        floodCtx.beginPath();
        floodCtx.moveTo(0, fh/2); floodCtx.lineTo(fw, fh/2);
        floodCtx.stroke();
        floodCtx.fillStyle = "rgba(59, 130, 246, 0.2)";
        floodCtx.strokeStyle = "#3b82f6";
        floodCtx.lineWidth = 2;
        floodCtx.beginPath();
        floodCtx.moveTo(0, fh);
        for (let i = 0; i < floodHistory.length; i++) {
            const x = (i / (floodHistory.length - 1)) * fw;
            const yVal = Math.min(floodHistory[i] / MAX_FLOOD_Y, 1.0); 
            const y = fh - (yVal * fh);
            floodCtx.lineTo(x, y);
        }
        floodCtx.lineTo(fw, fh);
        floodCtx.fill();
        floodCtx.stroke();

        // Land Chart
        const total = stats.total || 1;
        const fRatio = stats.forest / total;
        const dRatio = stats.deforest / total;
        landHistory.push({forest: fRatio, deforest: dRatio});
        landHistory.shift();
        const lw = landCanvas.width;
        const lh = landCanvas.height;
        landCtx.clearRect(0, 0, lw, lh);
        landCtx.fillStyle = "rgba(21, 128, 61, 0.6)"; 
        landCtx.beginPath();
        landCtx.moveTo(0, lh);
        for(let i=0; i<landHistory.length; i++) {
            const x = (i / (landHistory.length - 1)) * lw;
            const y = lh - (landHistory[i].forest * lh);
            landCtx.lineTo(x, y);
        }
        landCtx.lineTo(lw, lh);
        landCtx.fill();
        landCtx.fillStyle = "rgba(161, 98, 7, 0.6)"; 
        landCtx.beginPath();
        landCtx.moveTo(0, 0);
        for(let i=0; i<landHistory.length; i++) {
            const x = (i / (landHistory.length - 1)) * lw;
            const h = landHistory[i].deforest * lh;
            landCtx.lineTo(x, h); 
        }
        landCtx.lineTo(lw, 0);
        landCtx.fill();
    }

    // --- GRID & CELL SYSTEM ---

    class Cell {
        constructor(x, y, type) {
            this.x = x;
            this.y = y;
            this.type = type;
            this.isRestoring = false;
            this.saturation = 0.0; // 0.0 (Kering) -> 1.0 (Jenuh/Banjir)
        }

        draw() {
            // Warna dasar
            let baseColor;
            if (this.type === TYPE_VILLAGE) {
                if (floodLevel > 1500) baseColor = '#1d4ed8'; 
                else if (floodLevel > 500) baseColor = '#334155'; 
                else baseColor = COLOR_VILLAGE;
            } else if (this.type === TYPE_FOREST) baseColor = COLOR_FOREST;
            else if (this.type === TYPE_DEFOREST) baseColor = COLOR_DEFOREST;
            else if (this.type === TYPE_NATURAL) baseColor = COLOR_NATURAL;
            else baseColor = '#000';

            // Menggambar sel
            ctx.fillStyle = baseColor;
            ctx.fillRect(this.x * CELL_SIZE, this.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);

            // Overlay Kejenuhan (Visualisasi tanah basah)
            if (this.saturation > 0.1 && this.type !== TYPE_VILLAGE) {
                ctx.fillStyle = `rgba(0, 0, 50, ${this.saturation * 0.6})`; // Overlay gelap
                ctx.fillRect(this.x * CELL_SIZE, this.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
            }

            // Visual Restorasi
            if (this.isRestoring) {
                ctx.fillStyle = '#4ade80';
                ctx.fillRect(this.x * CELL_SIZE + 5, this.y * CELL_SIZE + 5, 5, 5);
                this.isRestoring = false; 
            } else {
                ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                ctx.strokeRect(this.x * CELL_SIZE, this.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
            }
        }
    }

    function initGrid() {
        grid = [];
        stats = { forest: 0, deforest: 0, natural: 0, total: 0 };
        for (let y = 0; y < ROWS; y++) {
            let row = [];
            for (let x = 0; x < COLS; x++) {
                let type;
                if (y >= ROWS - 5) { 
                    type = TYPE_VILLAGE;
                } else {
                    const rnd = Math.random();
                    if (rnd < 0.15) type = TYPE_NATURAL;
                    else type = TYPE_FOREST; 
                }
                row.push(new Cell(x, y, type));
            }
            grid.push(row);
        }
        particles = [];
        floodLevel = 0;
        floodHistory.fill(0);
        landHistory.fill({forest: 1, deforest: 0});
        
        simTimeMinutes = 360;
        dayCount = 1;
        
        draw();
        updateUI();
        updateTimeUI();
    }

    function updateTimeSystem() {
        // Apply speed multiplier to time
        simTimeMinutes += BASE_MINS_PER_FRAME * simSpeedMultiplier;
        
        if (simTimeMinutes >= 1440) { // 24 hours * 60 mins
            simTimeMinutes = 0;
            dayCount++;
        }

        const hours = Math.floor(simTimeMinutes / 60);
        
        // Define Day/Night (06:00 to 18:00 is Day)
        isDaytime = (hours >= 6 && hours < 18);
    }

    function updateEcosystem() {
        // Adjust activity frequency based on Speed Multiplier
        // Base checks (40) * Multiplier. If 5x speed, we do 200 checks per frame to keep up with time passing.
        const checksPerFrame = 40 * simSpeedMultiplier; 
        
        let f = 0, d = 0, n = 0, t = 0;
        let totalSat = 0;
        let soilCount = 0;

        for (let y = 0; y < ROWS - 5; y++) {
            for (let x = 0; x < COLS; x++) {
                const cell = grid[y][x];
                t++;
                if (cell.type === TYPE_FOREST) f++;
                else if (cell.type === TYPE_DEFOREST) d++;
                else if (cell.type === TYPE_NATURAL) n++;
                
                totalSat += cell.saturation;
                soilCount++;

                // LOGIKA PENGERINGAN ALAMI
                let evapFactor = isDaytime ? 2.5 : 0.5;
                let dryingRate = 0.0005; 

                if (cell.type === TYPE_FOREST) {
                    dryingRate = 0.003 * evapFactor; 
                } else if (cell.type === TYPE_DEFOREST) {
                    // FISIKA BARU: Efek Tepi Hutan
                    let forestNeighbors = 0;
                    if (x > 0 && grid[y][x-1].type === TYPE_FOREST) forestNeighbors++;
                    if (x < COLS-1 && grid[y][x+1].type === TYPE_FOREST) forestNeighbors++;
                    if (y > 0 && grid[y-1][x].type === TYPE_FOREST) forestNeighbors++;
                    if (y < ROWS-6 && grid[y+1][x].type === TYPE_FOREST) forestNeighbors++;

                    if (forestNeighbors > 0) {
                        dryingRate = 0.0015 * evapFactor; // Kering agak cepat
                    } else {
                        dryingRate = 0.0005 * evapFactor; // Kering lambat (genangan)
                    }
                }
                
                // Scale drying with simulation speed so physics matches time
                dryingRate *= simSpeedMultiplier;

                cell.saturation -= dryingRate;
                if (cell.saturation < 0) cell.saturation = 0;
            }
        }
        stats = { forest: f, deforest: d, natural: n, total: t };
        avgSaturation = (totalSat / soilCount) * 100;

        // --- DYNAMICS LOOP ---
        for (let i = 0; i < checksPerFrame; i++) {
            
            // 1. GANGGUAN ALAM (Dikurangi Drastis)
            if (Math.random() < naturalProb) {
                const rx = Math.floor(Math.random() * COLS);
                const ry = Math.floor(Math.random() * (ROWS - 5));
                if (grid[ry][rx].type === TYPE_FOREST) {
                    grid[ry][rx].type = TYPE_DEFOREST; 
                    grid[ry][rx].saturation = 0.5;
                }
            }

            // 2. LOGGING (Aktivitas Manusia)
            if (deforestPattern === 'random') {
                const rx = Math.floor(Math.random() * COLS);
                const ry = Math.floor(Math.random() * (ROWS - 5));
                const cell = grid[ry][rx];
                
                if (cell.type === TYPE_FOREST) {
                    if (Math.random() < loggingProb) cell.type = TYPE_DEFOREST;
                }
            } else {
                // POLA SISTEMATIS
                const ry = Math.floor(Math.random() * (ROWS - 5));
                for (let cx = COLS - 1; cx >= 0; cx--) {
                    const cell = grid[ry][cx];
                    if (cell.type === TYPE_FOREST) {
                        if (Math.random() < loggingProb) {
                            cell.type = TYPE_DEFOREST;
                        }
                        break; 
                    }
                }
            }

            // 3. RESTORASI
            const rxRestore = Math.floor(Math.random() * COLS);
            const ryRestore = Math.floor(Math.random() * (ROWS - 5));
            const cellRestore = grid[ryRestore][rxRestore];
            
            if (cellRestore.type === TYPE_DEFOREST) {
                if (Math.random() < restoreProb) {
                    cellRestore.type = TYPE_FOREST;
                    cellRestore.isRestoring = true;
                }
            }
        }
    }

    // --- PARTICLE PHYSICS ---

    class Particle {
        constructor() {
            this.x = Math.floor(Math.random() * COLS); 
            this.y = 0; 
            this.px = Math.random() * CELL_SIZE; 
            this.py = Math.random() * CELL_SIZE; 
            this.speed = 0.8; 
            this.active = true;
        }

        update() {
            this.y += this.speed; // Rain visual speed stays constant for stability

            if (this.y >= ROWS - 5) {
                this.active = false;
                floodLevel += 5; 
                return;
            }

            const gridY = Math.floor(this.y);
            const gridX = Math.floor(this.x);

            if (gridY >= 0 && gridY < ROWS && gridX >= 0 && gridX < COLS) {
                const cell = grid[gridY][gridX];
                
                let absorbChance = 0;
                let speedModifier = 1.0;

                if (useSoilVar) {
                    if (soilType === 'clay') {
                        absorbChance = 0.001; speedModifier = 1.3; 
                    } else if (soilType === 'sandy') {
                        absorbChance = 0.08; speedModifier = 0.7;
                    } else { // loam
                        absorbChance = 0.015; speedModifier = 1.0;
                    }
                } else {
                    absorbChance = 0.01; speedModifier = 1.0;
                }

                if (cell.type === TYPE_FOREST) {
                    absorbChance += 0.15; 
                    this.speed = 0.4 * speedModifier; 
                } 
                else if (cell.type === TYPE_DEFOREST) {
                    absorbChance *= 0.2; 
                    this.speed = 1.5 * speedModifier; 
                } 
                else if (cell.type === TYPE_NATURAL) {
                    absorbChance += 0.02; 
                    this.speed = 0.8 * speedModifier; 
                }

                absorbChance = absorbChance * (1.0 - cell.saturation);

                if (Math.random() < absorbChance) {
                    this.active = false;
                    let saturationGain = 0.05; 
                    if (cell.type === TYPE_DEFOREST) saturationGain = 0.15; 
                    
                    cell.saturation += saturationGain;
                    if (cell.saturation > 1.0) cell.saturation = 1.0;
                }
            }
        }

        draw() {
            ctx.fillStyle = COLOR_WATER;
            const drawX = (this.x * CELL_SIZE) + this.px;
            const drawY = (this.y * CELL_SIZE) + this.py;
            ctx.beginPath();
            ctx.arc(drawX, drawY, 2, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    function spawnRain() {
        if (particles.length > 1000) return;
        const density = rainIntensity / 80;
        for(let i=0; i<COLS; i++) {
            if(Math.random() < density) {
                particles.push(new Particle());
            }
        }
    }

    function loop() {
        if (!isRunning) return;
        frameCount++;

        updateTimeSystem();
        updateEcosystem();
        
        ctx.clearRect(0, 0, WIDTH, HEIGHT);
        spawnRain();
        
        for (let y = 0; y < ROWS; y++) {
            for (let x = 0; x < COLS; x++) {
                grid[y][x].draw();
            }
        }
        
        for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            p.update();
            if (!p.active) particles.splice(i, 1);
            else p.draw();
        }

        // Night Overlay
        if (!isDaytime) {
            ctx.fillStyle = 'rgba(2, 6, 23, 0.5)'; // Efek Malam
            ctx.fillRect(0, 0, WIDTH, HEIGHT);
        }
        
        if (floodLevel > 0) {
            let drainRate = 5 + (floodLevel * 0.05); 
            // Scale drain rate with sim speed (if time passes faster, water drains faster)
            drainRate *= simSpeedMultiplier; 
            
            floodLevel -= drainRate; 
            if (floodLevel < 0) floodLevel = 0;
        }
        if (floodLevel > 50) { 
            const maxH = 5 * CELL_SIZE; 
            const h = Math.min((floodLevel / 2000) * maxH, maxH);
            ctx.fillStyle = 'rgba(59, 130, 246, 0.5)';
            ctx.fillRect(0, HEIGHT - h, WIDTH, h);
        }
        
        updateUI();
        updateTimeUI();
        updateCharts();
        animationId = requestAnimationFrame(loop);
    }
    
    function draw() {
        ctx.clearRect(0, 0, WIDTH, HEIGHT);
        for (let y = 0; y < ROWS; y++) {
            for (let x = 0; x < COLS; x++) {
                grid[y][x].draw();
            }
        }
    }

    function updateTimeUI() {
        if (frameCount % 5 !== 0) return; 

        const h = Math.floor(simTimeMinutes / 60);
        const m = simTimeMinutes % 60;
        const timeStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
        
        timeDisplay.innerText = timeStr;
        dayDisplay.innerText = `Hari Ke-${dayCount}`;

        if (isDaytime) {
            weatherIcon.innerText = "‚òÄÔ∏è";
            evapoStatus.innerText = "Evapotranspirasi: Tinggi";
            evapoStatus.style.color = "#4ade80";
        } else {
            weatherIcon.innerText = "üåô";
            evapoStatus.innerText = "Evapotranspirasi: Rendah";
            evapoStatus.style.color = "#94a3b8";
        }
    }

    function updateUI() {
        if (frameCount % 5 !== 0) return;
        let val = Math.floor(floodLevel);
        textFlood.innerText = val + " m¬≥/s";
        if (val > 1000) {
            textFlood.style.color = '#ef4444';
            textFlood.innerText += " (!)";
        } else {
            textFlood.style.color = '#3b82f6';
        }
        const cover = Math.round((stats.forest / stats.total) * 100);
        textForest.innerText = cover + "%";
        if (cover < 30) {
            textForest.style.color = '#ef4444';
            ecoStatus.className = "status-badge status-danger";
            ecoStatus.innerText = "KRITIS (<30%)";
        } else if (cover < 50) {
            textForest.style.color = '#fbbf24';
            ecoStatus.className = "status-badge status-warning";
            ecoStatus.innerText = "WASPADA";
        } else {
            textForest.style.color = '#22c55e';
            ecoStatus.className = "status-badge status-safe";
            ecoStatus.innerText = "STABIL";
        }
        // Update Saturation Bar
        saturationBar.style.width = avgSaturation + "%";
        if (avgSaturation > 80) saturationBar.style.background = "#ef4444";
        else if (avgSaturation > 50) saturationBar.style.background = "#fbbf24";
        else saturationBar.style.background = "#60a5fa";
    }

    function getLabel(val, type) {
        if (val == 0) return "Nihil";
        if (val < 20) return "Jarang"; // Changed
        if (val < 50) return "Sedang";
        if (val < 80) return "Sering";
        return "Ekstrem";
    }
    
    // Label khusus untuk penebangan/restorasi (kecepatan)
    function getSpeedLabel(val) {
        if (val == 0) return "Nihil";
        if (val < 20) return "Sangat Lambat";
        if (val < 50) return "Sedang";
        if (val < 80) return "Cepat";
        return "Ekstrem";
    }

    sliderLogging.addEventListener('input', (e) => {
        const val = parseInt(e.target.value);
        loggingProb = val === 0 ? 0 : (val / 1000); 
        labelLogging.innerText = getSpeedLabel(val);
    });

    sliderNatural.addEventListener('input', (e) => {
        const val = parseInt(e.target.value);
        // FIX: Probabilitas jauh lebih kecil agar "Jarang"
        naturalProb = val === 0 ? 0 : (val / 100000); 
        labelNatural.innerText = getLabel(val);
    });

    sliderRestore.addEventListener('input', (e) => {
        const val = parseInt(e.target.value);
        restoreProb = val === 0 ? 0 : (val / 2000); 
        labelRestore.innerText = getSpeedLabel(val);
    });

    sliderRain.addEventListener('input', (e) => {
        rainIntensity = parseInt(e.target.value);
        let label = "Gerimis";
        if (rainIntensity > 20) label = "Normal";
        if (rainIntensity > 50) label = "Deras";
        if (rainIntensity > 80) label = "Badai";
        labelRain.innerText = label;
    });
    
    selectPattern.addEventListener('change', (e) => {
        deforestPattern = e.target.value;
    });

    soilSelect.addEventListener('change', (e) => {
        soilType = e.target.value;
    });

    soilToggle.addEventListener('change', (e) => {
        useSoilVar = e.target.checked;
        soilSelect.disabled = !useSoilVar; 
    });

    // Speed Control Function
    function setSimSpeed(speed, btn) {
        simSpeedMultiplier = speed;
        
        // Update UI Active State
        document.querySelectorAll('.btn-speed').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
    }

    btnStart.addEventListener('click', () => {
        isRunning = !isRunning;
        if (isRunning) {
            btnStart.innerText = "Stop";
            btnStart.classList.replace('btn-primary', 'btn-danger');
            loop();
        } else {
            btnStart.innerText = "Lanjut";
            btnStart.classList.replace('btn-danger', 'btn-primary');
            cancelAnimationFrame(animationId);
        }
    });

    btnReset.addEventListener('click', () => {
        isRunning = false;
        cancelAnimationFrame(animationId);
        btnStart.innerText = "Mulai";
        btnStart.classList.replace('btn-danger', 'btn-primary');
        initGrid();
    });

    initGrid();

</script>

</body>
</html>
