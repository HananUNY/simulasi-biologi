<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulasi Tata Kelola Lahan & Banjir</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --panel-color: #1e293b;
            --text-color: #e2e8f0;
            --accent-color: #3b82f6;
            --danger-color: #ef4444;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --forest-color: #15803d;
            --deforest-color: #a16207;
            --palm-color: #9333ea;
            /* UNGU */
            --natural-color: #64748b;
            --village-color: #334155;
            --night-overlay: rgba(2, 6, 23, 0.6);
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 360px 1fr;
            width: 100%;
            height: 100%;
        }

        .sidebar {
            background-color: var(--panel-color);
            padding: 15px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #334155;
            overflow-y: auto;
            z-index: 10;
            position: relative;
        }

        h1 {
            font-size: 1.1rem;
            margin-bottom: 2px;
            color: var(--accent-color);
        }

        h2 {
            font-size: 0.8rem;
            font-weight: normal;
            margin-bottom: 15px;
            color: #94a3b8;
        }

        /* WIDGETS */
        .time-widget {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #475569;
            text-align: center;
        }

        .time-display {
            font-size: 1.2rem;
            font-weight: bold;
            font-family: monospace;
            color: #fbbf24;
        }

        .day-display {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .weather-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .speed-controls {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
            border-top: 1px solid #334155;
            padding-top: 8px;
        }

        .btn-speed {
            padding: 4px 10px;
            font-size: 0.75rem;
            background: transparent;
            border: 1px solid #475569;
            color: #94a3b8;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-speed:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-speed.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            font-weight: bold;
        }

        .preset-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-preset {
            flex: 1;
            padding: 8px;
            border: 1px solid #475569;
            background: rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .btn-preset:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-color);
        }

        .control-group {
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
        }

        .control-header {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #94a3b8;
            margin-bottom: 10px;
            border-bottom: 1px solid #334155;
            padding-bottom: 5px;
        }

        label {
            display: block;
            font-size: 0.8rem;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .sub-label {
            font-size: 0.7rem;
            color: #94a3b8;
            margin-bottom: 5px;
            display: block;
            line-height: 1.2;
        }

        input[type="range"] {
            width: 100%;
            cursor: pointer;
            accent-color: var(--accent-color);
            height: 6px;
        }

        input[type="range"].restore-slider {
            accent-color: #10b981;
        }

        input[type="range"].logging-slider {
            accent-color: var(--danger-color);
        }

        input[type="range"].limit-slider {
            accent-color: var(--warning-color);
        }

        input[type="range"].reboisasi-slider {
            accent-color: #3b82f6;
        }

        input[type="range"].natural-slider {
            accent-color: #f59e0b;
        }

        input[type="range"].palm-slider {
            accent-color: #9333ea;
        }

        /* Ungu untuk sawit */

        .soil-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.8rem;
        }

        input[type="checkbox"] {
            accent-color: var(--accent-color);
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            background-color: #334155;
            color: white;
            border: 1px solid #475569;
            font-size: 0.85rem;
            cursor: pointer;
        }

        select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        select:focus {
            outline: 2px solid var(--accent-color);
        }

        .value-display {
            float: right;
            font-size: 0.8rem;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-top: 8px;
            width: 100%;
            text-align: center;
            box-sizing: border-box;
        }

        .status-safe {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            border: 1px solid #22c55e;
        }

        .status-warning {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }

        .status-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid #ef4444;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            margin-top: 5px;
        }

        button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid #475569;
            color: #cbd5e1;
        }

        .btn-info {
            background-color: #0ea5e9;
            color: white;
            margin-bottom: 15px;
        }

        .stats-panel {
            margin-top: auto;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #334155;
        }

        .stat-card {
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .stat-value {
            font-size: 0.9rem;
            font-weight: bold;
            font-family: monospace;
        }

        .main-view {
            position: relative;
            background-color: #020617;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        canvas#simCanvas {
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.6);
            border-radius: 4px;
            border: 1px solid #334155;
            max-height: 95vh;
            max-width: 100%;
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 70px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 4px;
            overflow: hidden;
        }

        canvas.mini-chart {
            width: 100%;
            height: 100%;
            display: block;
        }

        .legend {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            font-size: 0.7rem;
            margin-top: 5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .dot.forest {
            background: var(--forest-color);
        }

        .dot.deforest {
            background: var(--deforest-color);
        }

        .dot.palm {
            background: var(--palm-color);
        }

        .dot.restoring {
            background: #4ade80;
            animation: pulse 1s infinite;
        }

        .attribution {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #334155;
            font-size: 0.65rem;
            color: #64748b;
            text-align: center;
            line-height: 1.5;
        }

        .attribution strong {
            color: #94a3b8;
        }

        #floodWarningOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            box-sizing: border-box;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #floodWarningOverlay.active {
            opacity: 1;
            animation: pulse-alarm 1s infinite;
        }

        @keyframes pulse-alarm {
            0% {
                box-shadow: inset 0 0 0 0 rgba(239, 68, 68, 0);
                border: 0px solid transparent;
            }

            50% {
                box-shadow: inset 0 0 100px 20px rgba(239, 68, 68, 0.6);
                border: 8px solid #ef4444;
            }

            100% {
                box-shadow: inset 0 0 0 0 rgba(239, 68, 68, 0);
                border: 0px solid transparent;
            }
        }

        .warning-banner {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ef4444;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.2rem;
            z-index: 10000;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                top: -50px;
            }

            to {
                top: 20px;
            }
        }

        /* MODAL */
        .modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--panel-color);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            text-align: center;
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #94a3b8;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-content img {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #475569;
        }

        .modal-btn {
            background-color: var(--accent-color);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }

        .modal-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #334155;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: #94a3b8;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            color: var(--accent-color);
            border-bottom: 2px solid var(--accent-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            body {
                overflow: auto;
                height: auto;
            }

            .container {
                display: flex;
                flex-direction: column;
                height: auto;
            }

            .main-view {
                order: 1;
                height: auto;
                min-height: 350px;
                position: sticky;
                top: 0;
                z-index: 20;
            }

            .sidebar {
                order: 2;
                width: 100%;
                border-right: none;
                border-top: 1px solid #334155;
                height: auto;
                overflow: visible;
            }

            canvas#simCanvas {
                width: 100% !important;
                height: auto !important;
                max-height: 50vh;
                object-fit: contain;
            }
        }
    </style>
</head>

<body>

    <div id="floodWarningOverlay"></div>
    <div id="floodWarningBanner" class="warning-banner">‚ö†Ô∏è BAHAYA BANJIR KRITIS!</div>

    <div id="introModal" class="modal">
        <div class="modal-content">
            <h2>‚ÑπÔ∏è Penafian Edukasi</h2>
            <p>Simulasi ini adalah model penyederhanaan untuk tujuan pendidikan. Kita akan melihat dampak kebijakan
                pemerintah (batas izin lahan), laju deforestasi, dan konversi hutan menjadi kebun kelapa sawit.</p>
            <button id="btnUnderstand" class="modal-btn">Saya Paham & Lanjutkan</button>
        </div>
    </div>

    <div id="dataModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close" onclick="closeDataModal()">&times;</span>
            <h2>üåè Data Satelit</h2>
            <div class="modal-tabs">
                <button class="tab-btn active" onclick="switchTab('sumatra')">Sumatera</button>
                <button class="tab-btn" onclick="switchTab('kalimantan')">Kalimantan</button>
            </div>
            <div id="tab-sumatra" class="tab-content active">
                <p>Evolusi 1990 - 2020</p>
                <img src="https://placehold.co/600x400/1e293b/white?text=GIF+Data+Sumatera" alt="Sumatera">
                <p style="font-size:0.9rem">Analisis: Penurunan hutan signifikan akibat perkebunan.</p>
            </div>
            <div id="tab-kalimantan" class="tab-content">
                <p>Evolusi 1990 - 2020</p>
                <img src="https://placehold.co/600x400/1e293b/white?text=GIF+Data+Kalimantan" alt="Kalimantan">
                <p style="font-size:0.9rem">Analisis: Deforestasi pesat di area pesisir.</p>
            </div>
        </div>
    </div>

    <div class="container">
        <aside class="sidebar">
            <h1>Monitor Tata Kelola Lahan</h1>
            <h2>Simulasi Kebijakan & Dampak</h2>

            <div class="time-widget">
                <div id="weatherIcon" class="weather-icon">‚òÄÔ∏è</div>
                <div id="timeDisplay" class="time-display">12:00</div>
                <div id="dayDisplay" class="day-display">Hari Ke-1</div>
                <div style="font-size: 0.7rem; color: #4ade80; margin-top: 5px;" id="evapoStatus">Evapotranspirasi:
                    Tinggi</div>
                <div class="speed-controls">
                    <button class="btn-speed active" id="spd1" onclick="setSimSpeed(1, this)">1x</button>
                    <button class="btn-speed" id="spd2" onclick="setSimSpeed(2, this)">2x</button>
                    <button class="btn-speed" id="spd5" onclick="setSimSpeed(5, this)">5x</button>
                </div>
            </div>

            <button id="btnShowRealData" class="btn-speed btn-info"
                style="width: 100%; padding: 10px; border: none; font-weight: bold; margin-bottom: 20px;">üåè Lihat Data
                Real</button>

            <div class="control-group" style="background: rgba(255, 255, 255, 0.1);">
                <div class="control-header" style="color: #fbbf24;">0. Preset Skenario</div>
                <div class="preset-group">
                    <button class="btn-preset" onclick="applyPreset('1990')">Kondisi 1990</button>
                    <button class="btn-preset" onclick="applyPreset('2024')">Kondisi 2024</button>
                </div>
            </div>

            <div class="control-group">
                <div class="control-header">1. Industri & Ekonomi</div>

                <label style="color: #f59e0b;">
                    Batas Izin Pemerintah
                    <span id="limitVal" class="value-display" style="color:#f59e0b">50%</span>
                </label>
                <span class="sub-label">Max rasio lahan non-hutan yang diizinkan</span>
                <input type="range" class="limit-slider" id="limitSlider" min="0" max="100" value="50">

                <label style="color: #f87171; margin-top:10px;">
                    Aktivitas Pembukaan Lahan
                    <span id="loggingVal" class="value-display" style="color:#f87171">Rendah</span>
                </label>
                <span class="sub-label">Laju konversi hutan menjadi lahan gundul</span>
                <input type="range" class="logging-slider" id="loggingSlider" min="0" max="100" value="10">

                <label style="color: #9333ea; margin-top:10px;">
                    Konversi ke Kebun Sawit
                    <span id="palmVal" class="value-display" style="color:#9333ea">Nihil</span>
                </label>
                <span class="sub-label">Laju lahan gundul ditanami sawit</span>
                <input type="range" class="palm-slider" id="palmSlider" min="0" max="100" value="0">

                <label style="margin-top: 8px;">Pola Penebangan</label>
                <select id="deforestPattern">
                    <option value="random">Acak (Selektif)</option>
                    <option value="organized">Sistematis (Blok Besar)</option>
                </select>

                <div id="moratoriumStatus"
                    style="margin-top:8px; font-size:0.75rem; color:#4ade80; border:1px solid #4ade80; padding:4px; text-align:center; border-radius:4px; display:none;">
                    üîí MORATORIUM AKTIF (Batas Tercapai)
                </div>
            </div>

            <div class="control-group">
                <div class="control-header">2. Upaya Pemulihan & Alam</div>

                <label style="color: #10b981;">
                    Suksesi Alami (Natural)
                    <span id="restoreVal" class="value-display" style="color:#10b981">Rendah</span>
                </label>
                <span class="sub-label">Kemampuan alam memulihkan diri</span>
                <input type="range" class="restore-slider" id="restoreSlider" min="0" max="100" value="10">

                <label style="color: #3b82f6; margin-top:10px;">
                    Reboisasi (Aktif)
                    <span id="reboisasiVal" class="value-display" style="color:#3b82f6">Nihil</span>
                </label>
                <span class="sub-label">Penanaman pohon hutan oleh manusia</span>
                <input type="range" class="reboisasi-slider" id="reboisasiSlider" min="0" max="100" value="0">

                <label style="color: #f59e0b; margin-top:10px;">
                    Gangguan Alam (Bencana)
                    <span id="naturalVal" class="value-display" style="color:#f59e0b">Jarang</span>
                </label>
                <span class="sub-label">Kebakaran, Angin Kencang (Sangat Jarang)</span>
                <input type="range" class="natural-slider" id="naturalSlider" min="0" max="100" value="0">
            </div>

            <div class="control-group">
                <div class="control-header">3. Cuaca & Iklim</div>

                <div class="soil-controls">
                    <div class="toggle-row">
                        <span>Aktifkan Variabel Tanah</span>
                        <input type="checkbox" id="soilToggle" checked>
                    </div>
                    <select id="soilTypeSelect">
                        <option value="clay">Tanah Liat (Cepat Jenuh)</option>
                        <option value="loam" selected>Tanah Gembur (Sedang)</option>
                        <option value="sandy">Tanah Berpasir (Poros)</option>
                    </select>
                </div>

                <div style="margin-top:10px; margin-bottom:15px;">
                    <label style="font-size:0.7rem; color:#94a3b8;">Saturasi Tanah (Kejenuhan)</label>
                    <div style="width:100%; height:6px; background:#334155; border-radius:3px; overflow:hidden;">
                        <div id="saturationBar"
                            style="width:0%; height:100%; background:#60a5fa; transition:width 0.2s;"></div>
                    </div>
                </div>

                <label>
                    Curah Hujan
                    <span id="rainVal" class="value-display" style="color:var(--accent-color)">Gerimis</span>
                </label>
                <input type="range" id="rainSlider" min="0" max="100" value="15">
            </div>

            <div class="btn-group">
                <button id="btnStart" class="btn-primary">Mulai</button>
                <button id="btnReset" class="btn-outline">Reset</button>
            </div>

            <div class="stats-panel">
                <div class="stat-card">
                    <div class="stat-label">Hutan Alam</div>
                    <div class="stat-value" id="forestCoverText" style="color:#15803d">100%</div>
                    <div id="ecoStatus" class="status-badge status-safe" style="width:auto; margin:0;">STABIL</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Kebun Sawit</div>
                    <div class="stat-value" id="palmCoverText" style="color:#9333ea">0%</div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Komposisi Lahan</div>
                    <div class="chart-wrapper"><canvas id="landChart" class="mini-chart"></canvas></div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Level Banjir (Desa) <span id="floodLevelText"
                            style="float:right; color:#3b82f6;">0 cm</span></div>
                    <div class="chart-wrapper"><canvas id="floodChart" class="mini-chart"></canvas></div>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="dot forest"></div> Hutan
                    </div>
                    <div class="legend-item">
                        <div class="dot palm"></div> Sawit
                    </div>
                    <div class="legend-item">
                        <div class="dot deforest"></div> Gundul
                    </div>
                    <div class="legend-item">
                        <div class="dot" style="background:#0f172a; border:1px solid #60a5fa"></div> Jenuh
                    </div>
                </div>
            </div>

            <div class="attribution">
                Coding oleh <strong>Gemini AI</strong><br>
                Penyempurnaan oleh <strong>Hanan Dimas Prasetya</strong>
            </div>
        </aside>

        <main class="main-view">
            <canvas id="simCanvas"></canvas>
        </main>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        // Grid Config
        const COLS = 40; const ROWS = 40; const CELL_SIZE = 15;
        const WIDTH = COLS * CELL_SIZE; const HEIGHT = ROWS * CELL_SIZE;
        canvas.width = WIDTH; canvas.height = HEIGHT;

        // Types
        const TYPE_FOREST = 0;
        const TYPE_DEFOREST = 1; // Gundul Baru
        const TYPE_NATURAL = 2; // Batu/Sungai Alami
        const TYPE_VILLAGE = 3;
        const TYPE_PALM = 4; // Kelapa Sawit (Ungu)

        // Colors
        const COLOR_FOREST = '#15803d';
        const COLOR_DEFOREST = '#a16207'; // Cokelat/Orange
        const COLOR_NATURAL = '#64748b';
        const COLOR_VILLAGE = '#334155';
        const COLOR_WATER = '#60a5fa';
        const COLOR_PALM = '#9333ea'; // UNGU

        // State
        let grid = []; let particles = []; let isRunning = false; let animationId;
        let floodLevel = 0; let frameCount = 0;
        let simTimeMinutes = 360; let dayCount = 1; let isDaytime = true;
        let simSpeedMultiplier = 1;
        let stats = { forest: 0, deforest: 0, palm: 0, natural: 0, total: 0 };
        let avgSaturation = 0;

        // Parameters
        let loggingProb = 0.002;
        let governmentLimit = 0.5; // 50% default
        let palmConversionProb = 0.0; // NEW: Controlled via slider
        let restoreProb = 0.001;
        let reboisasiProb = 0.0;
        let naturalProb = 0.0;
        let rainIntensity = 15;
        let initialDeforestPercent = 0.0;
        let soilType = 'loam';
        let useSoilVar = true;
        let deforestPattern = 'random';

        // DOM
        const sliderLogging = document.getElementById('loggingSlider');
        const labelLogging = document.getElementById('loggingVal');
        const sliderLimit = document.getElementById('limitSlider');
        const labelLimit = document.getElementById('limitVal');
        const moratoriumStatus = document.getElementById('moratoriumStatus');
        const sliderRain = document.getElementById('rainSlider');
        const labelRain = document.getElementById('rainVal');
        const sliderPalm = document.getElementById('palmSlider'); // NEW
        const labelPalm = document.getElementById('palmVal');     // NEW

        const sliderRestore = document.getElementById('restoreSlider');
        const labelRestore = document.getElementById('restoreVal');
        const sliderReboisasi = document.getElementById('reboisasiSlider');
        const labelReboisasi = document.getElementById('reboisasiVal');
        const sliderNatural = document.getElementById('naturalSlider');
        const labelNatural = document.getElementById('naturalVal');
        const selectPattern = document.getElementById('deforestPattern');
        const soilSelect = document.getElementById('soilTypeSelect');
        const soilToggle = document.getElementById('soilToggle');

        const btnStart = document.getElementById('btnStart');
        const btnReset = document.getElementById('btnReset');
        const textFlood = document.getElementById('floodLevelText');
        const textForest = document.getElementById('forestCoverText');
        const textPalm = document.getElementById('palmCoverText');

        const timeDisplay = document.getElementById('timeDisplay');
        const dayDisplay = document.getElementById('dayDisplay');
        const weatherIcon = document.getElementById('weatherIcon');
        const evapoStatus = document.getElementById('evapoStatus');
        const floodOverlay = document.getElementById('floodWarningOverlay');
        const floodBanner = document.getElementById('floodWarningBanner');
        const ecoStatus = document.getElementById('ecoStatus');
        const saturationBar = document.getElementById('saturationBar');

        // Modal Logic
        document.getElementById('btnUnderstand').onclick = () => document.getElementById('introModal').style.display = 'none';
        document.getElementById('btnShowRealData').onclick = () => document.getElementById('dataModal').style.display = 'flex';
        window.closeDataModal = () => document.getElementById('dataModal').style.display = 'none';

        window.switchTab = function (island) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (island === 'sumatra') {
                document.querySelector("button[onclick=\"switchTab('sumatra')\"]").classList.add('active');
                document.getElementById('tab-sumatra').classList.add('active');
            } else {
                document.querySelector("button[onclick=\"switchTab('kalimantan')\"]").classList.add('active');
                document.getElementById('tab-kalimantan').classList.add('active');
            }
        }

        // Preset Logic
        window.applyPreset = function (year) {
            isRunning = false; cancelAnimationFrame(animationId);
            btnStart.innerText = "Mulai"; btnStart.classList.replace('btn-danger', 'btn-primary');

            if (year === '1990') {
                // 1990: Izin Ketat (45%), Logging Lambat, Sawit Minim
                initialDeforestPercent = 0.05;
                sliderLimit.value = 45; governmentLimit = 0.45; labelLimit.innerText = "45% (Ketat)";

                sliderLogging.value = 5; loggingProb = 5 / 1000; labelLogging.innerText = "Sangat Lambat";
                sliderPalm.value = 5; palmConversionProb = 5 / 2000; labelPalm.innerText = "Sangat Lambat";

                sliderRain.value = 15; rainIntensity = 15; labelRain.innerText = "Gerimis";

            } else if (year === '2024') {
                // 2024: Izin Longgar (90%), Logging Ekstrem, Sawit Pesat
                initialDeforestPercent = 0.40;
                sliderLimit.value = 90; governmentLimit = 0.90; labelLimit.innerText = "90% (Longgar)";

                sliderLogging.value = 60; loggingProb = 60 / 1000; labelLogging.innerText = "Cepat";
                sliderPalm.value = 50; palmConversionProb = 50 / 1000; labelPalm.innerText = "Cepat";

                sliderRain.value = 40; rainIntensity = 40; labelRain.innerText = "Normal";
            }
            initGrid();
        }

        // --- CHART ---
        const floodCanvas = document.getElementById('floodChart'); const floodCtx = floodCanvas.getContext('2d');
        const landCanvas = document.getElementById('landChart'); const landCtx = landCanvas.getContext('2d');
        let floodHistory = new Array(80).fill(0);
        let landHistory = new Array(80).fill({ forest: 1, palm: 0, deforest: 0 });

        function updateCharts() {
            if (frameCount % 5 !== 0) return;
            floodCanvas.width = floodCanvas.offsetWidth; floodCanvas.height = floodCanvas.offsetHeight;
            landCanvas.width = landCanvas.offsetWidth; landCanvas.height = landCanvas.offsetHeight;

            // Flood
            floodHistory.push(floodLevel); floodHistory.shift();
            floodCtx.clearRect(0, 0, floodCanvas.width, floodCanvas.height);
            floodCtx.strokeStyle = '#3b82f6'; floodCtx.lineWidth = 2; floodCtx.beginPath();
            const maxFlood = 2000;
            for (let i = 0; i < floodHistory.length; i++) {
                const x = (i / 80) * floodCanvas.width;
                const y = floodCanvas.height - (Math.min(floodHistory[i] / maxFlood, 1) * floodCanvas.height);
                if (i == 0) floodCtx.moveTo(x, y); else floodCtx.lineTo(x, y);
            }
            floodCtx.stroke();

            // Land
            const total = stats.total || 1;
            const fR = stats.forest / total; const pR = stats.palm / total; const dR = stats.deforest / total;
            landHistory.push({ forest: fR, palm: pR, deforest: dR }); landHistory.shift();

            landCtx.clearRect(0, 0, landCanvas.width, landCanvas.height);
            const w = landCanvas.width; const h = landCanvas.height;

            // Forest (Green)
            landCtx.fillStyle = '#15803d'; landCtx.beginPath(); landCtx.moveTo(0, h);
            for (let i = 0; i < 80; i++) landCtx.lineTo((i / 79) * w, h - (landHistory[i].forest * h));
            landCtx.lineTo(w, h); landCtx.fill();

            // Palm (Purple) - Stacked on Forest
            landCtx.fillStyle = '#9333ea'; landCtx.beginPath();
            for (let i = 0; i < 80; i++) landCtx.lineTo((i / 79) * w, h - (landHistory[i].forest * h));
            for (let i = 79; i >= 0; i--) landCtx.lineTo((i / 79) * w, h - ((landHistory[i].forest + landHistory[i].palm) * h));
            landCtx.fill();

            // Deforest (Brown) - Stacked on Palm
            landCtx.fillStyle = '#a16207'; landCtx.beginPath();
            for (let i = 0; i < 80; i++) landCtx.lineTo((i / 79) * w, h - ((landHistory[i].forest + landHistory[i].palm) * h));
            for (let i = 79; i >= 0; i--) landCtx.lineTo((i / 79) * w, h - ((landHistory[i].forest + landHistory[i].palm + landHistory[i].deforest) * h));
            landCtx.fill();
        }

        // --- LOGIC ---
        class Cell {
            constructor(x, y, type) {
                this.x = x; this.y = y; this.type = type;
                this.saturation = 0.0;
            }
            draw() {
                let c;
                if (this.type === TYPE_VILLAGE) c = (floodLevel > 1000) ? '#1d4ed8' : COLOR_VILLAGE;
                else if (this.type === TYPE_FOREST) c = COLOR_FOREST;
                else if (this.type === TYPE_PALM) c = COLOR_PALM;
                else if (this.type === TYPE_DEFOREST) c = COLOR_DEFOREST;
                else c = COLOR_NATURAL;

                ctx.fillStyle = c;
                ctx.fillRect(this.x * CELL_SIZE, this.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);

                if (this.saturation > 0.1 && this.type !== TYPE_VILLAGE) {
                    ctx.fillStyle = `rgba(0,0,50,${this.saturation * 0.6})`;
                    ctx.fillRect(this.x * CELL_SIZE, this.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                }
            }
        }

        class Particle {
            constructor() {
                this.x = Math.floor(Math.random() * COLS); this.y = 0;
                this.px = Math.random() * CELL_SIZE; this.py = Math.random() * CELL_SIZE;
                this.speed = 0.8; this.active = true;
            }
            update() {
                this.y += this.speed;
                if (this.y >= ROWS - 5) { this.active = false; floodLevel += 10; return; }

                const gy = Math.floor(this.y); const gx = Math.floor(this.x);
                if (gy >= 0 && gy < ROWS && gx >= 0 && gx < COLS) {
                    const cell = grid[gy][gx];
                    let absorb = 0.01; let spd = 1.0;

                    // Physics per type
                    if (cell.type === TYPE_FOREST) { absorb = 0.15; spd = 0.4; }
                    // UPDATE HERE: Sawit dikurangi drastis kemampuannya
                    else if (cell.type === TYPE_PALM) { absorb = 0.025; spd = 1.1; } // Absorb 0.08->0.025, Speed 0.7->1.1
                    else if (cell.type === TYPE_DEFOREST) { absorb = 0.002; spd = 1.5; }
                    else if (cell.type === TYPE_NATURAL) { absorb = 0.02; spd = 0.8; }

                    // Saturation logic
                    absorb *= (1.0 - cell.saturation);

                    if (Math.random() < absorb) {
                        this.active = false;
                        let satGain = 0.05;
                        if (cell.type === TYPE_DEFOREST) satGain = 0.2;
                        // UPDATE HERE: Sawit lebih cepat jenuh
                        else if (cell.type === TYPE_PALM) satGain = 0.15; // 0.1->0.15

                        cell.saturation += satGain;
                        if (cell.saturation > 1) cell.saturation = 1;
                    }
                    this.speed = spd;
                }
            }
            draw() {
                ctx.fillStyle = COLOR_WATER;
                ctx.beginPath(); ctx.arc((this.x * CELL_SIZE) + this.px, (this.y * CELL_SIZE) + this.py, 2, 0, Math.PI * 2); ctx.fill();
            }
        }

        function initGrid() {
            grid = [];
            for (let y = 0; y < ROWS; y++) {
                let row = [];
                for (let x = 0; x < COLS; x++) {
                    let t;
                    if (y >= ROWS - 5) t = TYPE_VILLAGE;
                    else {
                        let r = Math.random();
                        if (r < 0.15) t = TYPE_NATURAL;
                        else if (r < 0.15 + initialDeforestPercent) t = TYPE_DEFOREST;
                        else t = TYPE_FOREST;
                    }
                    row.push(new Cell(x, y, t));
                }
                grid.push(row);
            }
            particles = []; floodLevel = 0;
            simTimeMinutes = 360; dayCount = 1;
            draw(); updateUI();
        }

        function updateEcosystem() {
            let f = 0, d = 0, p = 0, n = 0, t = 0;
            let totalSat = 0; let soilCount = 0;

            for (let y = 0; y < ROWS - 5; y++) {
                for (let x = 0; x < COLS; x++) {
                    let cell = grid[y][x];
                    if (cell.type === TYPE_FOREST) f++;
                    else if (cell.type === TYPE_DEFOREST) d++;
                    else if (cell.type === TYPE_PALM) p++;
                    else if (cell.type === TYPE_NATURAL) n++;
                    t++;
                    totalSat += cell.saturation; soilCount++;

                    let dry = 0.0005;
                    let evap = isDaytime ? 2.5 : 0.5;
                    if (cell.type === TYPE_FOREST) dry = 0.003 * evap;
                    // UPDATE HERE: Sawit mengering lebih lambat (transpirasi kurang dibanding hutan)
                    else if (cell.type === TYPE_PALM) dry = 0.001 * evap; // 0.0015 -> 0.001

                    dry *= simSpeedMultiplier;
                    cell.saturation -= dry; if (cell.saturation < 0) cell.saturation = 0;
                }
            }
            stats = { forest: f, deforest: d, palm: p, natural: n, total: t };
            avgSaturation = (totalSat / soilCount) * 100;

            // Policy Check
            const openLandRatio = (d + p) / t;
            const isLimitReached = openLandRatio >= governmentLimit;

            if (isLimitReached) {
                moratoriumStatus.style.display = 'block';
            } else {
                moratoriumStatus.style.display = 'none';
            }

            const checks = 40 * simSpeedMultiplier;
            for (let i = 0; i < checks; i++) {
                const rx = Math.floor(Math.random() * COLS);
                const ry = Math.floor(Math.random() * (ROWS - 5));
                const cell = grid[ry][rx];

                // 1. LOGGING
                if (!isLimitReached && cell.type === TYPE_FOREST) {
                    if (Math.random() < loggingProb) cell.type = TYPE_DEFOREST;
                }

                // 2. PALM CONVERSION (New Variable)
                if (cell.type === TYPE_DEFOREST) {
                    if (Math.random() < palmConversionProb) cell.type = TYPE_PALM;
                }

                // 3. RESTORATION
                if (cell.type === TYPE_DEFOREST || cell.type === TYPE_PALM) {
                    if (Math.random() < restoreProb) cell.type = TYPE_FOREST;
                    else if (Math.random() < reboisasiProb) cell.type = TYPE_FOREST;
                }

                // 4. NATURAL
                if (Math.random() < naturalProb && cell.type === TYPE_FOREST) {
                    cell.type = TYPE_DEFOREST;
                    cell.saturation = 0.5;
                }
            }
        }

        function loop() {
            if (!isRunning) return;
            frameCount++;

            simTimeMinutes += 5 * simSpeedMultiplier;
            if (simTimeMinutes >= 1440) { simTimeMinutes = 0; dayCount++; }
            let h = Math.floor(simTimeMinutes / 60); isDaytime = (h >= 6 && h < 18);

            updateEcosystem();
            ctx.clearRect(0, 0, WIDTH, HEIGHT);

            if (particles.length < 1000) {
                let density = rainIntensity / 80;
                for (let i = 0; i < COLS; i++) if (Math.random() < density) particles.push(new Particle());
            }

            for (let y = 0; y < ROWS; y++) for (let x = 0; x < COLS; x++) grid[y][x].draw();

            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i]; p.update();
                if (!p.active) particles.splice(i, 1); else p.draw();
            }

            if (!isDaytime) { ctx.fillStyle = 'rgba(2,6,23,0.5)'; ctx.fillRect(0, 0, WIDTH, HEIGHT); }

            if (floodLevel > 0) {
                let drain = 2.0 + (floodLevel * 0.01);
                floodLevel -= drain; if (floodLevel < 0) floodLevel = 0;
            }
            if (floodLevel > 50) {
                let h = Math.min((floodLevel / 2000) * 5 * CELL_SIZE, 5 * CELL_SIZE);
                ctx.fillStyle = 'rgba(59,130,246,0.5)'; ctx.fillRect(0, HEIGHT - h, WIDTH, h);
            }

            updateUI(); updateCharts();
            animationId = requestAnimationFrame(loop);
        }

        function draw() {
            ctx.clearRect(0, 0, WIDTH, HEIGHT);
            for (let y = 0; y < ROWS; y++) for (let x = 0; x < COLS; x++) grid[y][x].draw();
        }

        function updateUI() {
            if (frameCount % 5 !== 0) return;
            let h = Math.floor(simTimeMinutes / 60); let m = simTimeMinutes % 60;
            timeDisplay.innerText = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            dayDisplay.innerText = `Hari Ke-${dayCount}`;
            evapoStatus.innerText = isDaytime ? "Evapotranspirasi: Tinggi" : "Evapotranspirasi: Rendah";
            evapoStatus.style.color = isDaytime ? "#4ade80" : "#94a3b8";
            weatherIcon.innerText = isDaytime ? "‚òÄÔ∏è" : "üåô";

            let val = Math.floor(floodLevel);
            textFlood.innerText = val + " m¬≥";
            if (val > 1000) {
                textFlood.style.color = '#ef4444';
                floodOverlay.classList.add('active'); floodBanner.style.display = 'block';
            } else {
                textFlood.style.color = '#3b82f6';
                floodOverlay.classList.remove('active'); floodBanner.style.display = 'none';
            }

            let total = stats.total || 1;
            textForest.innerText = Math.round((stats.forest / total) * 100) + "%";
            textPalm.innerText = Math.round((stats.palm / total) * 100) + "%";

            saturationBar.style.width = avgSaturation + "%";
            if (avgSaturation > 80) saturationBar.style.background = "#ef4444";
            else if (avgSaturation > 50) saturationBar.style.background = "#f59e0b";
            else saturationBar.style.background = "#60a5fa";

            const fRatio = (stats.forest / total) * 100;
            if (fRatio < 30) {
                ecoStatus.className = "status-badge status-danger"; ecoStatus.innerText = "KRITIS (<30%)";
            } else if (fRatio < 50) {
                ecoStatus.className = "status-badge status-warning"; ecoStatus.innerText = "WASPADA";
            } else {
                ecoStatus.className = "status-badge status-safe"; ecoStatus.innerText = "STABIL";
            }
        }

        // Events
        sliderLogging.addEventListener('input', (e) => {
            loggingProb = e.target.value / 1000;
            document.getElementById('loggingVal').innerText = getLabel(e.target.value);
        });
        sliderLimit.addEventListener('input', (e) => {
            governmentLimit = e.target.value / 100;
            document.getElementById('limitVal').innerText = e.target.value + "%";
        });
        sliderRain.addEventListener('input', (e) => {
            rainIntensity = parseInt(e.target.value);
            let l = "Gerimis"; if (rainIntensity > 20) l = "Normal"; if (rainIntensity > 50) l = "Deras"; if (rainIntensity > 80) l = "Badai";
            document.getElementById('rainVal').innerText = l;
        });

        sliderNatural.addEventListener('input', (e) => {
            naturalProb = e.target.value / 100000;
            document.getElementById('naturalVal').innerText = getLabel(e.target.value);
        });
        sliderRestore.addEventListener('input', (e) => {
            restoreProb = e.target.value / 2000;
            document.getElementById('restoreVal').innerText = getLabel(e.target.value);
        });
        sliderReboisasi.addEventListener('input', (e) => {
            reboisasiProb = e.target.value / 1000;
            document.getElementById('reboisasiVal').innerText = getLabel(e.target.value);
        });
        sliderPalm.addEventListener('input', (e) => { // NEW Event Listener
            palmConversionProb = e.target.value / 1000;
            document.getElementById('palmVal').innerText = getLabel(e.target.value);
        });

        selectPattern.addEventListener('change', (e) => { deforestPattern = e.target.value; });
        soilSelect.addEventListener('change', (e) => { soilType = e.target.value; });
        soilToggle.addEventListener('change', (e) => {
            useSoilVar = e.target.checked;
            soilSelect.disabled = !useSoilVar;
        });

        function getLabel(v) { if (v == 0) return "Nihil"; if (v < 20) return "Lambat"; if (v < 50) return "Sedang"; return "Cepat"; }
        function setSimSpeed(s, b) {
            simSpeedMultiplier = s;
            document.querySelectorAll('.btn-speed').forEach(btn => btn.classList.remove('active'));
            if (b) b.classList.add('active');
        }

        btnStart.onclick = () => {
            isRunning = !isRunning;
            if (isRunning) { btnStart.innerText = "Stop"; btnStart.classList.replace('btn-primary', 'btn-danger'); loop(); }
            else { btnStart.innerText = "Lanjut"; btnStart.classList.replace('btn-danger', 'btn-primary'); cancelAnimationFrame(animationId); }
        };
        btnReset.onclick = () => { isRunning = false; cancelAnimationFrame(animationId); btnStart.innerText = "Mulai"; btnStart.classList.replace('btn-danger', 'btn-primary'); initGrid(); };

        initGrid();
    </script>
</body>

</html>